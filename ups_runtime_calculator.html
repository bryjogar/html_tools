<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPS Runtime & Load Estimator | Homelab Playground</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        obsidian: {
                            bg: '#1e1e1e',       // Main background
                            pane: '#252526',     // Headers/Panels
                            border: '#3c3c3c',   // Borders
                            accent: '#7c3aed',   // Violet Primary
                            text: '#cccccc'      // Standard Text
                        }
                    },
                    fontFamily: {
                        mono: ['"Fira Code"', 'Consolas', 'Monaco', 'monospace'],
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e1e1e; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; 
        }

        /* Number Input styling removal for cleaner look */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* Updated Input Styling for better contrast */
        .obsidian-input {
            @apply bg-[#111827] border border-obsidian-border text-gray-200 placeholder-gray-600 px-3 py-2 rounded focus:outline-none focus:border-obsidian-accent focus:ring-1 focus:ring-obsidian-accent font-mono text-sm w-full transition-all;
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden bg-obsidian-bg text-obsidian-text font-sans">

    <header class="h-14 bg-obsidian-pane border-b border-obsidian-border flex items-center justify-between px-6 shrink-0 z-20">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-battery-half text-obsidian-accent text-xl"></i>
            <h1 class="font-bold text-lg tracking-wide text-white">UPS Runtime Estimator</h1>
        </div>
        <div class="text-xs text-gray-500 font-mono">v1.0.1</div>
    </header>

    <main class="flex-1 overflow-y-auto overflow-x-hidden p-6">
        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-7 flex flex-col gap-6">
                <div class="bg-obsidian-pane border border-obsidian-border rounded-lg p-5 shadow-lg">
                    <h2 class="text-sm uppercase tracking-wider font-semibold text-gray-400 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-server"></i> Rack Equipment
                    </h2>
                    
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="deviceName" placeholder="Device Name (e.g. Dell R720)" class="obsidian-input flex-grow">
                        <input type="number" id="deviceWatts" placeholder="Watts" class="obsidian-input w-24 text-center">
                        <button onclick="addDevice()" class="bg-obsidian-accent hover:bg-violet-600 text-white px-4 rounded transition-colors flex items-center justify-center border border-obsidian-accent">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>

                    <div class="border border-obsidian-border rounded overflow-hidden bg-[#111827]">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-obsidian-pane text-gray-400 font-mono text-xs uppercase border-b border-obsidian-border">
                                <tr>
                                    <th class="p-3">Device</th>
                                    <th class="p-3 text-right">Load</th>
                                    <th class="p-3 text-center w-12">Action</th>
                                </tr>
                            </thead>
                            <tbody id="deviceList" class="divide-y divide-obsidian-border">
                                <tr id="emptyState">
                                    <td colspan="3" class="p-8 text-center text-gray-600 italic bg-obsidian-pane/50">
                                        No devices added yet.
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot class="bg-obsidian-pane font-bold border-t border-obsidian-border text-white">
                                <tr>
                                    <td class="p-3 text-right">Total Load:</td>
                                    <td class="p-3 text-right font-mono text-obsidian-accent"><span id="totalWatts">0</span> W</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="mt-2 text-xs text-gray-500">
                        <i class="fa-solid fa-circle-info mr-1"></i> Check your specific device labels or IPMI for accurate wattage.
                    </div>
                </div>
            </div>

            <div class="lg:col-span-5 flex flex-col gap-6">
                
                <div class="bg-obsidian-pane border border-obsidian-border rounded-lg p-5 shadow-lg">
                    <h2 class="text-sm uppercase tracking-wider font-semibold text-gray-400 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-bolt"></i> UPS Configuration
                    </h2>

                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block font-medium">Rating (VA)</label>
                                <input type="number" id="upsVa" value="1500" oninput="calculate()" class="obsidian-input">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block font-medium">Power Factor</label>
                                <select id="upsPf" onchange="calculate()" class="obsidian-input appearance-none cursor-pointer">
                                    <option value="0.6">0.6 (Older/Basic)</option>
                                    <option value="0.8">0.8 (Standard)</option>
                                    <option value="0.9" selected>0.9 (Modern/Sine)</option>
                                    <option value="1.0">1.0 (Unity)</option>
                                </select>
                            </div>
                        </div>

                        <div class="border-t border-obsidian-border my-2 pt-2">
                            <label class="text-xs text-obsidian-accent mb-2 block uppercase font-bold tracking-wide">Battery Bank</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs text-gray-400 mb-1 block font-medium">System Voltage (V)</label>
                                    <input type="number" id="battVolts" value="24" oninput="calculate()" class="obsidian-input">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400 mb-1 block font-medium">Total Capacity (Ah)</label>
                                    <input type="number" id="battAh" value="18" oninput="calculate()" class="obsidian-input">
                                </div>
                            </div>
                            <div class="mt-3 text-xs text-gray-500 italic bg-black/20 p-2 rounded border border-white/5">
                                Tip: A standard 1500VA UPS often has 2x 12V 9Ah batteries = 24V System, 9Ah Total.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-obsidian-pane border border-obsidian-border rounded-lg p-5 shadow-lg flex-1 flex flex-col justify-center relative overflow-hidden">
                    <div class="absolute -right-10 -bottom-10 text-9xl text-black/20 rotate-12 pointer-events-none">
                        <i class="fa-solid fa-stopwatch"></i>
                    </div>

                    <div class="z-10">
                        <h3 class="text-gray-400 text-sm uppercase tracking-widest mb-1">Estimated Runtime</h3>
                        <div class="text-4xl font-mono font-bold text-white mb-6" id="runtimeDisplay">
                            -- <span class="text-lg font-sans text-gray-500 font-normal">min</span>
                        </div>

                        <div class="mb-1 flex justify-between text-xs font-mono text-gray-400">
                            <span>Load Capacity</span>
                            <span id="loadPercentText">0%</span>
                        </div>
                        <div class="h-4 bg-[#111827] rounded-full overflow-hidden border border-white/10">
                            <div id="loadBar" class="h-full bg-obsidian-accent w-0 transition-all duration-500 ease-out"></div>
                        </div>
                        <div class="flex justify-between text-xs mt-2 text-gray-500">
                            <span>0%</span>
                            <span id="maxLoadText">Max: 1350W</span>
                        </div>

                        <div id="overloadWarning" class="hidden mt-4 bg-red-900/20 border border-red-900 text-red-400 p-3 rounded text-xs flex items-center gap-2">
                            <i class="fa-solid fa-triangle-exclamation"></i>
                            <span>Warning: Total load exceeds UPS rated capacity!</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <footer class="bg-obsidian-pane border-t border-obsidian-border py-2 text-center shrink-0 z-10">
        <a href="https://homelabplayground.com" class="text-gray-500 hover:text-violet-400 text-xs transition-colors font-sans no-underline">
            HomeLab Playground
        </a>
    </footer>

    <script>
        // State
        let devices = [];

        // DOM Elements
        const elDeviceName = document.getElementById('deviceName');
        const elDeviceWatts = document.getElementById('deviceWatts');
        const elDeviceList = document.getElementById('deviceList');
        const elEmptyState = document.getElementById('emptyState');
        const elTotalWatts = document.getElementById('totalWatts');
        
        const elUpsVa = document.getElementById('upsVa');
        const elUpsPf = document.getElementById('upsPf');
        const elBattVolts = document.getElementById('battVolts');
        const elBattAh = document.getElementById('battAh');

        const elRuntimeDisplay = document.getElementById('runtimeDisplay');
        const elLoadBar = document.getElementById('loadBar');
        const elLoadPercentText = document.getElementById('loadPercentText');
        const elMaxLoadText = document.getElementById('maxLoadText');
        const elOverloadWarning = document.getElementById('overloadWarning');

        // Add Device on Enter Key
        elDeviceWatts.addEventListener("keypress", function(event) {
            if (event.key === "Enter") addDevice();
        });

        function addDevice() {
            const name = elDeviceName.value.trim() || `Device ${devices.length + 1}`;
            const watts = parseFloat(elDeviceWatts.value);

            if (isNaN(watts) || watts <= 0) {
                alert("Please enter a valid wattage.");
                return;
            }

            devices.push({ id: Date.now(), name, watts });
            elDeviceName.value = '';
            elDeviceWatts.value = '';
            renderList();
            calculate();
        }

        function removeDevice(id) {
            devices = devices.filter(d => d.id !== id);
            renderList();
            calculate();
        }

        function renderList() {
            if (devices.length === 0) {
                elDeviceList.innerHTML = '';
                elDeviceList.appendChild(elEmptyState);
                elEmptyState.style.display = 'table-row';
                return;
            }

            elDeviceList.innerHTML = '';
            devices.forEach(device => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 transition-colors group";
                tr.innerHTML = `
                    <td class="p-3 font-medium text-gray-300">${device.name}</td>
                    <td class="p-3 text-right font-mono text-gray-400">${device.watts} W</td>
                    <td class="p-3 text-center">
                        <button onclick="removeDevice(${device.id})" class="text-gray-600 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </td>
                `;
                elDeviceList.appendChild(tr);
            });
        }

        function calculate() {
            // 1. Calculate Total Load
            const totalLoadW = devices.reduce((sum, d) => sum + d.watts, 0);
            elTotalWatts.innerText = totalLoadW;

            // 2. Get UPS Specs
            const va = parseFloat(elUpsVa.value) || 0;
            const pf = parseFloat(elUpsPf.value) || 0.9;
            const volts = parseFloat(elBattVolts.value) || 0;
            const ah = parseFloat(elBattAh.value) || 0;

            const maxUpsWatts = va * pf;
            elMaxLoadText.innerText = `Max: ${Math.round(maxUpsWatts)}W`;

            // 3. Update Load Bar
            let loadPercent = 0;
            if (maxUpsWatts > 0) {
                loadPercent = (totalLoadW / maxUpsWatts) * 100;
            }

            elLoadPercentText.innerText = `${loadPercent.toFixed(1)}%`;
            elLoadBar.style.width = `${Math.min(loadPercent, 100)}%`;

            // Color Logic
            elLoadBar.className = "h-full transition-all duration-500 ease-out"; // Reset
            if (loadPercent > 100) {
                elLoadBar.classList.add('bg-red-500');
                elOverloadWarning.classList.remove('hidden');
            } else if (loadPercent > 80) {
                elLoadBar.classList.add('bg-yellow-500');
                elOverloadWarning.classList.add('hidden');
            } else {
                elLoadBar.classList.add('bg-obsidian-accent');
                elOverloadWarning.classList.add('hidden');
            }

            // 4. Calculate Runtime
            // Peukert's law approximation for Lead Acid UPS.
            // Formula: (Battery Volts * Ah * Efficiency) / LoadWatts
            // Efficiency ~0.85 (Inverter loss + discharge curve)
            
            if (totalLoadW === 0 || volts === 0 || ah === 0) {
                elRuntimeDisplay.innerHTML = `-- <span class="text-lg font-sans text-gray-500 font-normal">min</span>`;
                return;
            }

            // At very high loads relative to capacity (C-rate > 1), lead acid is extremely inefficient.
            // We'll apply a simple dynamic efficiency curve
            const cRate = totalLoadW / (volts * ah);
            let efficiency = 0.85; 
            if (cRate > 1.5) efficiency = 0.65; // Heavy load penalty
            else if (cRate > 1.0) efficiency = 0.75;

            const batteryWh = volts * ah;
            let hours = (batteryWh * efficiency) / totalLoadW;

            // Convert to readable format
            const totalMinutes = Math.floor(hours * 60);
            
            let timeString = "";
            if (totalMinutes < 1) {
                timeString = "< 1 <span class='text-lg font-sans text-gray-500 font-normal'>min</span>";
            } else if (totalMinutes < 60) {
                timeString = `${totalMinutes} <span class="text-lg font-sans text-gray-500 font-normal">min</span>`;
            } else {
                const h = Math.floor(totalMinutes / 60);
                const m = totalMinutes % 60;
                timeString = `${h}<span class="text-sm text-gray-500 font-normal mx-1">h</span> ${m}<span class="text-sm text-gray-500 font-normal">m</span>`;
            }

            elRuntimeDisplay.innerHTML = timeString;
        }

        // Initial render
        renderList();
    </script>
</body>
</html>