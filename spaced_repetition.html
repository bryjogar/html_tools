<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlashRecall - Spaced Repetition Tool</title>
    <link rel="icon" type="image/png" href="https://homelabplayground.com/favicon.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        obsidian: {
                            bg: '#1e1e1e',      // Main background
                            pane: '#252526',    // Headers/Panels
                            border: '#3c3c3c',  // Borders
                            accent: '#7c3aed',  // Violet Primary
                            text: '#cccccc'     // Standard Text
                        }
                    },
                    fontFamily: {
                        mono: ['"Fira Code"', 'Consolas', 'Monaco', 'monospace'],
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    },
                    animation: {
                        'flip': 'flip 0.6s preserve-3d'
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e1e1e; 
        }
        ::-webkit-scrollbar-thumb {
            background: #3c3c3c; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4b4b4b; 
        }

        /* 3D Flip Card Styles */
        .perspective-1000 {
            perspective: 1000px;
        }
        .transform-style-3d {
            transform-style: preserve-3d;
        }
        .backface-hidden {
            backface-visibility: hidden;
        }
        .rotate-y-180 {
            transform: rotateY(180deg);
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden bg-obsidian-bg text-obsidian-text font-sans selection:bg-obsidian-accent selection:text-white">

    <header class="h-14 flex-shrink-0 bg-obsidian-pane border-b border-obsidian-border flex items-center justify-between px-4 z-20 shadow-lg">
        <div class="flex items-center gap-3 cursor-pointer" onclick="app.showDashboard()">
            <div class="w-8 h-8 rounded bg-obsidian-accent flex items-center justify-center text-white">
                <i class="fa-solid fa-brain"></i>
            </div>
            <h1 class="text-lg font-bold text-white tracking-wide">FlashRecall</h1>
        </div>
        
        <div id="header-actions" class="flex items-center gap-2">
            </div>
    </header>

    <main class="flex-1 overflow-y-auto relative p-4 md:p-6" id="main-container">
        
        <div id="view-dashboard" class="max-w-4xl mx-auto space-y-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-white">Your Decks</h2>
                    <p class="text-sm text-gray-400 mt-1">Select a subject to manage cards or start studying.</p>
                </div>
                <button onclick="app.toggleModal('modal-add-deck')" class="px-4 py-2 bg-obsidian-accent hover:bg-violet-600 text-white rounded transition-colors flex items-center gap-2 text-sm font-medium shadow-lg shadow-violet-900/20">
                    <i class="fa-solid fa-plus"></i> New Deck
                </button>
            </div>

            <div id="deck-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </div>
            
            <div id="empty-state" class="hidden text-center py-20 opacity-50">
                <i class="fa-solid fa-layer-group text-6xl mb-4 text-obsidian-border"></i>
                <p>No decks found. Create one to get started!</p>
            </div>
        </div>

        <div id="view-deck" class="hidden max-w-4xl mx-auto space-y-6">
            <div class="flex items-center gap-2 text-sm text-gray-500 mb-2">
                <button onclick="app.showDashboard()" class="hover:text-obsidian-accent"><i class="fa-solid fa-arrow-left"></i> Back to Dashboard</button>
                <span>/</span>
                <span id="deck-breadcrumb" class="text-gray-300">Subject</span>
            </div>

            <div class="bg-obsidian-pane border border-obsidian-border rounded-lg p-6 flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h2 id="deck-title" class="text-3xl font-bold text-white mb-2">Deck Name</h2>
                    <div class="flex gap-4 text-sm">
                        <span class="text-gray-400"><i class="fa-solid fa-layer-group mr-1"></i> <span id="deck-total-count">0</span> Cards</span>
                        <span class="text-obsidian-accent"><i class="fa-solid fa-clock mr-1"></i> <span id="deck-due-count">0</span> Due Today</span>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="app.toggleModal('modal-add-card')" class="px-4 py-2 border border-obsidian-border hover:bg-white/5 rounded text-sm transition-colors">
                        <i class="fa-solid fa-plus mr-1"></i> Add Card
                    </button>
                    <button id="btn-study-now" onclick="app.startStudy()" class="px-6 py-2 bg-obsidian-accent hover:bg-violet-600 text-white rounded font-medium shadow-lg shadow-violet-900/20 transition-colors">
                        <i class="fa-solid fa-play mr-2"></i> Study Now
                    </button>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-white border-b border-obsidian-border pb-2">Cards in Deck</h3>
                <div id="card-list" class="space-y-3">
                    </div>
            </div>
        </div>

        <div id="view-study" class="hidden h-full flex flex-col items-center justify-center max-w-2xl mx-auto pb-10">
            
            <div class="w-full flex justify-between items-center mb-6 px-2">
                <button onclick="app.showDeckView(app.currentDeckId)" class="text-gray-500 hover:text-white text-sm">
                    <i class="fa-solid fa-times mr-1"></i> Quit
                </button>
                <div class="text-sm font-mono text-obsidian-accent">
                    <span id="study-progress">0</span> Remaining
                </div>
            </div>

            <div class="relative w-full h-80 md:h-96 perspective-1000 group cursor-pointer" onclick="app.flipCard()">
                <div id="flashcard-inner" class="relative w-full h-full text-center transition-transform duration-500 transform-style-3d shadow-xl rounded-xl border border-obsidian-border bg-obsidian-pane">
                    
                    <div class="absolute w-full h-full backface-hidden flex flex-col items-center justify-center p-8">
                        <span class="text-xs uppercase tracking-widest text-gray-500 mb-4 font-mono">Question</span>
                        <div id="card-front" class="text-xl md:text-2xl font-medium text-white leading-relaxed">
                            Front Content
                        </div>
                        <div class="absolute bottom-4 text-xs text-gray-600 animate-pulse">Tap to flip</div>
                    </div>

                    <div class="absolute w-full h-full backface-hidden rotate-y-180 flex flex-col items-center justify-center p-8 bg-obsidian-pane rounded-xl border border-obsidian-border">
                        <span class="text-xs uppercase tracking-widest text-obsidian-accent mb-4 font-mono">Answer</span>
                        <div id="card-back" class="text-xl md:text-2xl font-medium text-white leading-relaxed">
                            Back Content
                        </div>
                    </div>
                </div>
            </div>

            <div id="study-controls" class="mt-8 grid grid-cols-4 gap-3 w-full opacity-0 pointer-events-none transition-opacity duration-300">
                <button onclick="app.rateCard(0)" class="flex flex-col items-center justify-center p-3 rounded bg-[#2a1a1a] border border-red-900/50 hover:bg-red-900/20 text-red-400 transition-colors">
                    <span class="text-xs font-bold mb-1">Again</span>
                    <span class="text-[10px] opacity-70">&lt; 1m</span>
                </button>
                <button onclick="app.rateCard(3)" class="flex flex-col items-center justify-center p-3 rounded bg-[#2a2a2a] border border-gray-700 hover:bg-gray-700/30 text-gray-300 transition-colors">
                    <span class="text-xs font-bold mb-1">Hard</span>
                    <span class="text-[10px] opacity-70" id="label-hard">2d</span>
                </button>
                <button onclick="app.rateCard(4)" class="flex flex-col items-center justify-center p-3 rounded bg-[#1a2a1a] border border-green-900/50 hover:bg-green-900/20 text-green-400 transition-colors">
                    <span class="text-xs font-bold mb-1">Good</span>
                    <span class="text-[10px] opacity-70" id="label-good">4d</span>
                </button>
                <button onclick="app.rateCard(5)" class="flex flex-col items-center justify-center p-3 rounded bg-[#1a202a] border border-blue-900/50 hover:bg-blue-900/20 text-blue-400 transition-colors">
                    <span class="text-xs font-bold mb-1">Easy</span>
                    <span class="text-[10px] opacity-70" id="label-easy">7d</span>
                </button>
            </div>

            <div id="study-complete" class="hidden text-center mt-10">
                <i class="fa-solid fa-check-circle text-5xl text-green-500 mb-4"></i>
                <h3 class="text-xl text-white font-bold">Session Complete!</h3>
                <p class="text-gray-400 mt-2">You've reviewed all cards due for this deck.</p>
                <button onclick="app.showDashboard()" class="mt-6 px-6 py-2 bg-obsidian-accent text-white rounded hover:bg-violet-600 transition-colors">Back to Dashboard</button>
            </div>
        </div>

    </main>

    <div id="modal-add-deck" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-obsidian-pane border border-obsidian-border rounded-lg w-full max-w-md shadow-2xl">
            <div class="p-4 border-b border-obsidian-border flex justify-between items-center">
                <h3 class="text-white font-bold">Create New Deck</h3>
                <button onclick="app.toggleModal('modal-add-deck')" class="text-gray-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-mono text-gray-400 mb-2">DECK NAME</label>
                    <input type="text" id="input-deck-name" class="w-full bg-obsidian-bg border border-obsidian-border rounded p-3 text-white focus:outline-none focus:border-obsidian-accent font-sans placeholder-gray-600" placeholder="e.g., Japanese Vocabulary">
                </div>
                <button onclick="app.createDeck()" class="w-full py-3 bg-obsidian-accent hover:bg-violet-600 text-white rounded font-medium transition-colors">Create Deck</button>
            </div>
        </div>
    </div>

    <div id="modal-add-card" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-obsidian-pane border border-obsidian-border rounded-lg w-full max-w-lg shadow-2xl">
            <div class="p-4 border-b border-obsidian-border flex justify-between items-center">
                <h3 class="text-white font-bold">Add New Card</h3>
                <button onclick="app.toggleModal('modal-add-card')" class="text-gray-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-mono text-gray-400 mb-2">FRONT (QUESTION)</label>
                    <textarea id="input-card-front" rows="3" class="w-full bg-obsidian-bg border border-obsidian-border rounded p-3 text-white focus:outline-none focus:border-obsidian-accent font-mono placeholder-gray-600" placeholder="What is the powerhouse of the cell?"></textarea>
                </div>
                <div>
                    <label class="block text-xs font-mono text-gray-400 mb-2">BACK (ANSWER)</label>
                    <textarea id="input-card-back" rows="3" class="w-full bg-obsidian-bg border border-obsidian-border rounded p-3 text-white focus:outline-none focus:border-obsidian-accent font-mono placeholder-gray-600" placeholder="Mitochondria"></textarea>
                </div>
                <button onclick="app.createCard()" class="w-full py-3 bg-obsidian-accent hover:bg-violet-600 text-white rounded font-medium transition-colors">Add Card</button>
            </div>
        </div>
    </div>

    <footer class="bg-obsidian-pane border-t border-obsidian-border py-3 text-center shrink-0 z-10 flex flex-col md:flex-row justify-center items-center gap-3">
        <a href="https://homelabplayground.com" class="text-gray-500 hover:text-violet-400 text-xs transition-colors font-sans no-underline">
            HomeLab Playground
        </a>
    
        <span class="hidden md:block text-obsidian-border mx-1">|</span>
    
        <a href="https://www.buymeacoffee.com/bryjogar" target="_blank" class="inline-flex items-center px-3 py-1 bg-obsidian-accent hover:bg-violet-600 text-white text-xs font-sans rounded-full transition-colors no-underline">
            <i class="fa-solid fa-mug-hot mr-1.5"></i>
            <span>Support The Tools</span>
        </a>
    </footer>

    <script>
        const app = {
            data: {
                decks: []
            },
            currentDeckId: null,
            studyQueue: [],
            currentCardIndex: 0,
            isFlipped: false,

            init() {
                this.loadData();
                this.renderDashboard();
            },

            loadData() {
                const stored = localStorage.getItem('flashrecall_data');
                if (stored) {
                    this.data = JSON.parse(stored);
                } else {
                    // Seed initial data if empty
                    this.data.decks = [];
                }
            },

            saveData() {
                localStorage.setItem('flashrecall_data', JSON.stringify(this.data));
            },

            // --- Navigation ---
            
            showDashboard() {
                this.hideAllViews();
                document.getElementById('view-dashboard').classList.remove('hidden');
                this.renderDashboard();
            },

            showDeckView(deckId) {
                this.currentDeckId = deckId;
                this.hideAllViews();
                document.getElementById('view-deck').classList.remove('hidden');
                this.renderDeckView(deckId);
            },

            hideAllViews() {
                ['view-dashboard', 'view-deck', 'view-study'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById('modal-add-deck').classList.add('hidden');
                document.getElementById('modal-add-card').classList.add('hidden');
            },

            toggleModal(modalId) {
                const el = document.getElementById(modalId);
                el.classList.toggle('hidden');
                if(!el.classList.contains('hidden')) {
                    const input = el.querySelector('input, textarea');
                    if(input) setTimeout(() => input.focus(), 100);
                }
            },

            // --- Deck Logic ---

            createDeck() {
                const nameInput = document.getElementById('input-deck-name');
                const name = nameInput.value.trim();
                if (!name) return;

                const newDeck = {
                    id: Date.now().toString(),
                    name: name,
                    cards: []
                };

                this.data.decks.push(newDeck);
                this.saveData();
                nameInput.value = '';
                this.toggleModal('modal-add-deck');
                this.renderDashboard();
            },

            deleteDeck(e, id) {
                e.stopPropagation();
                if(!confirm("Are you sure? This will delete all cards in this deck.")) return;
                this.data.decks = this.data.decks.filter(d => d.id !== id);
                this.saveData();
                this.renderDashboard();
            },

            renderDashboard() {
                const grid = document.getElementById('deck-grid');
                grid.innerHTML = '';
                
                if (this.data.decks.length === 0) {
                    document.getElementById('empty-state').classList.remove('hidden');
                    return;
                } else {
                    document.getElementById('empty-state').classList.add('hidden');
                }

                const today = new Date().setHours(0,0,0,0);

                this.data.decks.forEach(deck => {
                    const dueCount = deck.cards.filter(c => c.dueDate <= Date.now()).length;
                    
                    const el = document.createElement('div');
                    el.className = 'bg-obsidian-pane border border-obsidian-border rounded-lg p-5 hover:border-obsidian-accent cursor-pointer transition-all hover:translate-y-[-2px] group relative';
                    el.onclick = () => this.showDeckView(deck.id);
                    el.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-obsidian-accent text-lg">
                                <i class="fa-solid fa-layer-group"></i>
                            </div>
                            <button onclick="app.deleteDeck(event, '${deck.id}')" class="text-gray-600 hover:text-red-400 p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                        <h3 class="font-bold text-white text-lg mb-1 truncate">${deck.name}</h3>
                        <div class="flex justify-between items-center text-sm mt-4">
                            <span class="text-gray-500">${deck.cards.length} Cards</span>
                            <span class="${dueCount > 0 ? 'text-obsidian-accent font-bold' : 'text-gray-600'}">
                                ${dueCount} Due
                            </span>
                        </div>
                    `;
                    grid.appendChild(el);
                });
            },

            // --- Card Logic ---

            renderDeckView(deckId) {
                const deck = this.data.decks.find(d => d.id === deckId);
                if (!deck) return this.showDashboard();

                document.getElementById('deck-title').innerText = deck.name;
                document.getElementById('deck-breadcrumb').innerText = deck.name;
                document.getElementById('deck-total-count').innerText = deck.cards.length;

                const dueCards = deck.cards.filter(c => c.dueDate <= Date.now());
                document.getElementById('deck-due-count').innerText = dueCards.length;

                // Toggle Study Button state
                const studyBtn = document.getElementById('btn-study-now');
                if(dueCards.length > 0) {
                    studyBtn.disabled = false;
                    studyBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    studyBtn.disabled = true;
                    studyBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }

                const list = document.getElementById('card-list');
                list.innerHTML = '';

                // Sort cards: Due first, then New
                const sortedCards = [...deck.cards].sort((a,b) => a.dueDate - b.dueDate);

                if (sortedCards.length === 0) {
                    list.innerHTML = '<div class="text-gray-500 text-center py-4 italic">No cards yet. Add one!</div>';
                }

                sortedCards.forEach((card, idx) => {
                    const isDue = card.dueDate <= Date.now();
                    const dateStr = new Date(card.dueDate).toLocaleDateString();
                    
                    const row = document.createElement('div');
                    row.className = 'bg-white/5 border border-white/5 rounded p-3 flex justify-between items-center hover:bg-white/10 transition-colors';
                    row.innerHTML = `
                        <div class="flex-1 min-w-0 mr-4">
                            <div class="text-white font-medium truncate">${this.escapeHtml(card.front)}</div>
                            <div class="text-gray-500 text-xs truncate mt-1">${this.escapeHtml(card.back)}</div>
                        </div>
                        <div class="text-right flex flex-col items-end gap-1">
                            <span class="text-xs ${isDue ? 'text-obsidian-accent font-bold' : 'text-gray-600'}">
                                ${isDue ? 'Due Now' : 'Due: ' + dateStr}
                            </span>
                            <button onclick="app.deleteCard('${card.id}')" class="text-gray-600 hover:text-red-400 text-xs">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(row);
                });
            },

            createCard() {
                const deck = this.data.decks.find(d => d.id === this.currentDeckId);
                if (!deck) return;

                const front = document.getElementById('input-card-front').value.trim();
                const back = document.getElementById('input-card-back').value.trim();

                if (!front || !back) return;

                const newCard = {
                    id: Date.now().toString(),
                    front: front,
                    back: back,
                    dueDate: Date.now(), // Due immediately
                    interval: 0, // Days
                    repetition: 0,
                    efactor: 2.5 // Ease Factor (SM-2 default)
                };

                deck.cards.push(newCard);
                this.saveData();
                
                document.getElementById('input-card-front').value = '';
                document.getElementById('input-card-back').value = '';
                document.getElementById('input-card-front').focus();
                
                this.renderDeckView(this.currentDeckId);
                // Keep modal open for rapid entry, maybe show a toast (omitted for brevity)
            },

            deleteCard(cardId) {
                if(!confirm("Delete this card?")) return;
                const deck = this.data.decks.find(d => d.id === this.currentDeckId);
                if(deck) {
                    deck.cards = deck.cards.filter(c => c.id !== cardId);
                    this.saveData();
                    this.renderDeckView(this.currentDeckId);
                }
            },

            // --- Study Logic (SM-2 Algorithm Simplified) ---

            startStudy() {
                const deck = this.data.decks.find(d => d.id === this.currentDeckId);
                if(!deck) return;

                // Filter cards due now or in the past
                this.studyQueue = deck.cards.filter(c => c.dueDate <= Date.now());
                
                // Shuffle logic can be added here, but simplest is random sort
                this.studyQueue.sort(() => Math.random() - 0.5);

                if (this.studyQueue.length === 0) return;

                this.currentCardIndex = 0;
                this.hideAllViews();
                document.getElementById('view-study').classList.remove('hidden');
                
                this.renderStudyCard();
            },

            renderStudyCard() {
                if(this.currentCardIndex >= this.studyQueue.length) {
                    // Session finished
                    document.getElementById('flashcard-inner').parentElement.classList.add('hidden');
                    document.getElementById('study-controls').classList.add('opacity-0', 'pointer-events-none');
                    document.getElementById('study-complete').classList.remove('hidden');
                    document.getElementById('study-progress').innerText = "0";
                    return;
                } else {
                     document.getElementById('flashcard-inner').parentElement.classList.remove('hidden');
                     document.getElementById('study-complete').classList.add('hidden');
                }

                const card = this.studyQueue[this.currentCardIndex];
                document.getElementById('card-front').innerText = card.front;
                document.getElementById('card-back').innerText = card.back;
                document.getElementById('study-progress').innerText = this.studyQueue.length - this.currentCardIndex;

                // Reset Flip
                this.isFlipped = false;
                document.getElementById('flashcard-inner').classList.remove('rotate-y-180');
                
                // Hide Controls
                document.getElementById('study-controls').classList.remove('opacity-100', 'pointer-events-auto');
                document.getElementById('study-controls').classList.add('opacity-0', 'pointer-events-none');

                // Calculate estimated intervals for UI labels (approximation)
                this.updateIntervalLabels(card);
            },

            flipCard() {
                if (this.isFlipped) return; // Already flipped
                this.isFlipped = true;
                document.getElementById('flashcard-inner').classList.add('rotate-y-180');
                
                // Show Controls
                setTimeout(() => {
                    document.getElementById('study-controls').classList.remove('opacity-0', 'pointer-events-none');
                    document.getElementById('study-controls').classList.add('opacity-100', 'pointer-events-auto');
                }, 300);
            },

            updateIntervalLabels(card) {
                // Simplified display of next interval based on button choice
                // Logic mirrors rateCard calculation briefly for display
                const calcNext = (q) => {
                     // Simplified clone of SM-2 logic below for UI hint
                     let int = card.interval;
                     if (q === 0) return '1m';
                     if (int === 0) return '1d';
                     if (int === 1) return (q === 3 ? '2d' : (q === 5 ? '4d' : '3d'));
                     return Math.round(int * card.efactor) + 'd';
                };

                // These are rough estimates for UI feedback
                // Hard (3) Good (4) Easy (5)
                // 0 is handled separately
            },

            rateCard(quality) {
                // SM-2 Inspired Algorithm
                // q: 0-5. 0=Fail, 3=Pass(Hard), 4=Pass(Good), 5=Pass(Easy)
                
                const card = this.studyQueue[this.currentCardIndex];
                
                if (quality < 3) {
                    // Failed
                    card.repetition = 0;
                    card.interval = 1; // 1 day
                    // In a true system, we might show it again in the same session. 
                    // For simplicity, we push it to tomorrow.
                } else {
                    // Passed
                    if (card.repetition === 0) {
                        card.interval = 1;
                    } else if (card.repetition === 1) {
                        card.interval = 6;
                    } else {
                        card.interval = Math.round(card.interval * card.efactor);
                    }
                    card.repetition += 1;
                }

                // Update E-Factor
                // EF' = EF + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02))
                card.efactor = card.efactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
                if (card.efactor < 1.3) card.efactor = 1.3;

                // Set new Due Date (ms + days * ms_per_day)
                // If failed (0), we set it to now + 1 min or just tomorrow for simplicity here? 
                // Let's stick to days for persistent DB.
                // If quality 0, maybe re-queue in same session?
                
                if (quality === 0) {
                     // Re-queue at end of current session array to see again now?
                     // For MVP, reset to day 0 (Due Now) but push to end of array
                     // Actually, if we just update the card in the master deck, we can re-push to queue
                     // But let's keep it simple: Failed = Due Tomorrow (Interval 0->1)
                     card.dueDate = Date.now() + (24 * 60 * 60 * 1000); 
                } else {
                     card.dueDate = Date.now() + (card.interval * 24 * 60 * 60 * 1000);
                }

                // Update Master Deck Data (reference works because objects are passed by ref, but we reload from localstorage usually)
                // Since `studyQueue` contains references to objects in `this.data.decks`, modification updates main state.
                
                this.saveData();

                // Next Card
                this.currentCardIndex++;
                this.renderStudyCard();
            },

            escapeHtml(text) {
                if (!text) return text;
                return text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

    </script>
</body>
</html>