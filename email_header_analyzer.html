<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Header Hop Analyzer - Homelab Playground</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        obsidian: {
                            bg: '#1e1e1e',
                            pane: '#252526',
                            border: '#3c3c3c',
                            accent: '#7c3aed',
                            text: '#cccccc'
                        }
                    },
                    fontFamily: {
                        mono: ['"Fira Code"', 'Consolas', 'Monaco', 'monospace'],
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Fira+Code:wght@400;500&display=swap');

        body {
            background-color: #1e1e1e;
            color: #cccccc;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }
        ::-webkit-scrollbar-thumb {
            background: #3c3c3c;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #505050;
        }

        .timeline-line {
            position: relative;
        }

        .timeline-line::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #7c3aed, #3c3c3c);
            transform: translateX(-50%);
        }

        .hop-card {
            transition: all 0.3s ease;
        }

        .hop-card:hover {
            transform: translateX(4px);
        }

        .failure-badge {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden font-sans">

    <header class="h-14 bg-obsidian-pane border-b border-obsidian-border flex items-center px-6 shrink-0 justify-between">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-envelope-circle-check text-obsidian-accent"></i>
            <h1 class="font-semibold text-lg tracking-wide">Email Header Hop Analyzer</h1>
        </div>
        <div class="text-xs text-gray-500 flex items-center gap-2">
            <i class="fa-solid fa-lock"></i>
            <span>Client-side only processing</span>
        </div>
    </header>

    <main class="flex-1 overflow-auto p-4 md:p-8">
        <div class="max-w-6xl mx-auto space-y-6">
            
            <!-- Input Section -->
            <div class="bg-obsidian-pane border border-obsidian-border rounded-lg overflow-hidden">
                <div class="h-10 bg-obsidian-pane/50 border-b border-obsidian-border flex items-center justify-between px-4">
                    <span class="text-xs font-mono uppercase tracking-wider text-gray-400">Raw Email Headers</span>
                    <div class="flex gap-2">
                        <button onclick="pasteHeaders()" class="text-xs text-obsidian-accent hover:text-white transition-colors">
                            <i class="fa-regular fa-clipboard mr-1"></i> Paste
                        </button>
                        <button onclick="clearAll()" class="text-xs text-red-400 hover:text-red-300 transition-colors">
                            <i class="fa-solid fa-trash mr-1"></i> Clear
                        </button>
                    </div>
                </div>
                <textarea 
                    id="headerInput" 
                    class="w-full h-64 bg-[#111827] p-4 text-sm font-mono text-gray-300 focus:text-white outline-none resize-none"
                    placeholder="Paste raw email headers here...&#10;&#10;Example:&#10;Received: from mail.example.com ([192.168.1.1])&#10;  by mx.google.com with ESMTPS id ...&#10;  for &lt;user@example.com&gt;;&#10;  Mon, 1 Jan 2024 12:00:00 -0800 (PST)"
                    spellcheck="false"
                ></textarea>
            </div>

            <!-- Analysis Results -->
            <div id="resultsSection" class="hidden space-y-6">
                
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-obsidian-pane border border-obsidian-border rounded-lg p-4">
                        <div class="text-xs text-gray-500 uppercase mb-1">Total Hops</div>
                        <div id="totalHops" class="text-2xl font-bold text-white">0</div>
                    </div>
                    <div class="bg-obsidian-pane border border-obsidian-border rounded-lg p-4">
                        <div class="text-xs text-gray-500 uppercase mb-1">Total Time</div>
                        <div id="totalTime" class="text-2xl font-bold text-obsidian-accent">0s</div>
                    </div>
                    <div class="bg-obsidian-pane border border-obsidian-border rounded-lg p-4">
                        <div class="text-xs text-gray-500 uppercase mb-1">SPF Status</div>
                        <div id="spfStatus" class="text-2xl font-bold">-</div>
                    </div>
                    <div class="bg-obsidian-pane border border-obsidian-border rounded-lg p-4">
                        <div class="text-xs text-gray-500 uppercase mb-1">DKIM Status</div>
                        <div id="dkimStatus" class="text-2xl font-bold">-</div>
                    </div>
                </div>

                <!-- Timeline Visualization -->
                <div class="bg-obsidian-pane border border-obsidian-border rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-route text-obsidian-accent"></i>
                        Delivery Timeline
                    </h2>
                    <div id="timelineContainer" class="space-y-4"></div>
                </div>

                <!-- Detailed Hop Information -->
                <div class="bg-obsidian-pane border border-obsidian-border rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-list text-obsidian-accent"></i>
                        Hop Details
                    </h2>
                    <div id="hopDetails" class="space-y-3"></div>
                </div>

                <!-- Authentication Results -->
                <div id="authSection" class="bg-obsidian-pane border border-obsidian-border rounded-lg p-6 hidden">
                    <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-shield-halved text-obsidian-accent"></i>
                        Authentication Results
                    </h2>
                    <div id="authDetails" class="space-y-2 font-mono text-sm"></div>
                </div>

            </div>

        </div>
    </main>

    <footer class="bg-obsidian-pane border-t border-obsidian-border py-3 text-center shrink-0 flex flex-col md:flex-row justify-center items-center gap-3">
        <a href="https://homelabplayground.com" class="text-gray-500 hover:text-violet-400 text-xs transition-colors font-sans no-underline">
            HomeLab Playground
        </a>
        <span class="hidden md:block text-obsidian-border mx-1">|</span>
        <a href="https://www.buymeacoffee.com/bryjogar" target="_blank" class="inline-flex items-center px-3 py-1 bg-obsidian-accent hover:bg-violet-600 text-white text-xs font-sans rounded-full transition-colors no-underline">
            <i class="fa-solid fa-mug-hot mr-1.5"></i>
            <span>Support The Tools</span>
        </a>
    </footer>

    <script>
        const headerInput = document.getElementById('headerInput');
        const resultsSection = document.getElementById('resultsSection');

        headerInput.addEventListener('input', () => {
            const headers = headerInput.value.trim();
            if (headers) {
                analyzeHeaders(headers);
            } else {
                resultsSection.classList.add('hidden');
            }
        });

        async function pasteHeaders() {
            try {
                const text = await navigator.clipboard.readText();
                headerInput.value = text;
                analyzeHeaders(text.trim());
            } catch (err) {
                console.error('Failed to read clipboard:', err);
            }
        }

        function clearAll() {
            headerInput.value = '';
            resultsSection.classList.add('hidden');
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;

            // Try standard Date parsing first (handles many formats)
            const parsed = new Date(dateStr);
            if (!isNaN(parsed.getTime())) {
                return parsed;
            }

            // Try RFC 2822 format with numeric timezone: "Mon, 1 Jan 2024 12:00:00 -0800"
            const rfc2822Numeric = dateStr.match(/^([A-Za-z]{3}),?\s+(\d{1,2})\s+([A-Za-z]{3})\s+(\d{4})\s+(\d{2}):(\d{2}):(\d{2})\s+([+-]\d{4})/);
            if (rfc2822Numeric) {
                const months = {
                    'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                    'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
                };
                const month = months[rfc2822Numeric[3]];
                if (month === undefined) return null;
                
                const day = parseInt(rfc2822Numeric[2]);
                const year = parseInt(rfc2822Numeric[4]);
                const hour = parseInt(rfc2822Numeric[5]);
                const minute = parseInt(rfc2822Numeric[6]);
                const second = parseInt(rfc2822Numeric[7]);
                const tzOffset = rfc2822Numeric[8];
                
                const date = new Date(Date.UTC(year, month, day, hour, minute, second));
                // Adjust for timezone offset
                const tzHours = parseInt(tzOffset.substring(1, 3));
                const tzMins = parseInt(tzOffset.substring(3, 5));
                const tzSign = tzOffset[0] === '+' ? -1 : 1;
                date.setUTCHours(date.getUTCHours() + (tzSign * tzHours));
                date.setUTCMinutes(date.getUTCMinutes() + (tzSign * tzMins));
                return date;
            }

            // Try RFC 2822 format with timezone abbreviation: "Mon, 1 Jan 2024 12:00:00 PST"
            const rfc2822Abbr = dateStr.match(/^([A-Za-z]{3}),?\s+(\d{1,2})\s+([A-Za-z]{3})\s+(\d{4})\s+(\d{2}):(\d{2}):(\d{2})\s+([A-Z]{3,4})/);
            if (rfc2822Abbr) {
                const months = {
                    'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                    'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
                };
                const month = months[rfc2822Abbr[3]];
                if (month === undefined) return null;
                
                const day = parseInt(rfc2822Abbr[2]);
                const year = parseInt(rfc2822Abbr[4]);
                const hour = parseInt(rfc2822Abbr[5]);
                const minute = parseInt(rfc2822Abbr[6]);
                const second = parseInt(rfc2822Abbr[7]);
                
                // Create date string that Date() can parse (timezone abbreviations are tricky)
                const dateStr2 = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}T${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}:${String(second).padStart(2, '0')}`;
                const date = new Date(dateStr2);
                if (!isNaN(date.getTime())) {
                    return date;
                }
            }

            return null;
        }

        function extractServerInfo(receivedLine) {
            // Extract server/hostname from Received header
            const patterns = [
                /from\s+([^\s\(]+)/i,
                /by\s+([^\s\(]+)/i,
                /\(([^\)]+)\)/,
            ];

            for (const pattern of patterns) {
                const match = receivedLine.match(pattern);
                if (match) {
                    return match[1].replace(/[<>\[\]]/g, '');
                }
            }

            return 'Unknown Server';
        }

        function extractIP(receivedLine) {
            const ipPattern = /\[?(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})\]?/;
            const match = receivedLine.match(ipPattern);
            return match ? match[1] : null;
        }

        function analyzeHeaders(headers) {
            const lines = headers.split('\n');
            const receivedHeaders = [];
            let currentReceived = '';
            let authResults = null;
            let spfResult = null;
            let dkimResult = null;

            // Parse headers
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                
                // Handle multi-line headers (continuation lines start with space/tab)
                if (trimmedLine.toLowerCase().startsWith('received:') || 
                    (currentReceived && (line.startsWith(' ') || line.startsWith('\t')))) {
                    if (trimmedLine.toLowerCase().startsWith('received:')) {
                        if (currentReceived) {
                            receivedHeaders.push(currentReceived);
                        }
                        currentReceived = trimmedLine.substring(9).trim();
                    } else if (currentReceived) {
                        currentReceived += ' ' + trimmedLine;
                    }
                } else {
                    if (currentReceived) {
                        receivedHeaders.push(currentReceived);
                        currentReceived = '';
                    }
                }

                // Parse Authentication-Results header
                if (trimmedLine.toLowerCase().startsWith('authentication-results:')) {
                    authResults = trimmedLine.substring(22).trim();
                    // Continue reading multi-line
                    for (let j = i + 1; j < lines.length; j++) {
                        const nextLine = lines[j];
                        if (nextLine.trim() && !nextLine.match(/^\s/)) break;
                        authResults += ' ' + nextLine.trim();
                    }
                    
                    // Extract SPF and DKIM results (handle various formats)
                    const spfMatch = authResults.match(/spf=(\w+)/i) || authResults.match(/spf\s+(\w+)/i);
                    const dkimMatch = authResults.match(/dkim=(\w+)/i) || authResults.match(/dkim\s+(\w+)/i);
                    spfResult = spfMatch ? spfMatch[1].toLowerCase() : null;
                    dkimResult = dkimMatch ? dkimMatch[1].toLowerCase() : null;
                }
            }

            if (currentReceived) {
                receivedHeaders.push(currentReceived);
            }

            // Process received headers (they're in reverse order - oldest first)
            const hops = [];
            for (let i = receivedHeaders.length - 1; i >= 0; i--) {
                const received = receivedHeaders[i];
                const server = extractServerInfo(received);
                const ip = extractIP(received);
                
                // Extract timestamp - try multiple patterns
                let timestamp = null;
                // Pattern 1: Date at end after semicolon: "; Mon, 1 Jan 2024 12:00:00 -0800"
                let dateMatch = received.match(/;\s*([A-Za-z]{3},?\s+\d{1,2}\s+[A-Za-z]{3}\s+\d{4}\s+\d{2}:\d{2}:\d{2}[^;]*)$/);
                if (!dateMatch) {
                    // Pattern 2: Date with timezone abbreviation: "; Mon, 1 Jan 2024 12:00:00 PST"
                    dateMatch = received.match(/;\s*([A-Za-z]{3},?\s+\d{1,2}\s+[A-Za-z]{3}\s+\d{4}\s+\d{2}:\d{2}:\d{2}\s+[A-Z]{3,4})/);
                }
                if (!dateMatch) {
                    // Pattern 3: ISO format or other formats
                    dateMatch = received.match(/;\s*([^;]+)$/);
                }
                if (dateMatch) {
                    timestamp = parseDate(dateMatch[1].trim());
                }

                hops.push({
                    server: server,
                    ip: ip,
                    timestamp: timestamp,
                    raw: received
                });
            }

            // Calculate time differences
            let totalTime = 0;
            for (let i = 0; i < hops.length; i++) {
                if (i > 0 && hops[i].timestamp && hops[i-1].timestamp) {
                    const diff = (hops[i].timestamp - hops[i-1].timestamp) / 1000; // seconds
                    hops[i].timeAtPrevious = diff;
                    totalTime += diff;
                }
            }

            // Display results
            displayResults(hops, totalTime, spfResult, dkimResult, authResults);
        }

        function formatTime(seconds) {
            if (seconds < 1) {
                return `${(seconds * 1000).toFixed(0)}ms`;
            } else if (seconds < 60) {
                return `${seconds.toFixed(2)}s`;
            } else {
                const mins = Math.floor(seconds / 60);
                const secs = (seconds % 60).toFixed(2);
                return `${mins}m ${secs}s`;
            }
        }

        function formatDate(date) {
            if (!date) return 'Unknown';
            return date.toLocaleString();
        }

        function displayResults(hops, totalTime, spfResult, dkimResult, authResults) {
            resultsSection.classList.remove('hidden');

            // Update summary
            document.getElementById('totalHops').textContent = hops.length;
            document.getElementById('totalTime').textContent = formatTime(totalTime);

            // SPF Status
            const spfStatusEl = document.getElementById('spfStatus');
            if (spfResult) {
                const isPass = spfResult === 'pass';
                spfStatusEl.textContent = spfResult.toUpperCase();
                spfStatusEl.className = `text-2xl font-bold ${isPass ? 'text-green-400' : 'text-red-400 failure-badge'}`;
            } else {
                spfStatusEl.textContent = 'N/A';
                spfStatusEl.className = 'text-2xl font-bold text-gray-500';
            }

            // DKIM Status
            const dkimStatusEl = document.getElementById('dkimStatus');
            if (dkimResult) {
                const isPass = dkimResult === 'pass';
                dkimStatusEl.textContent = dkimResult.toUpperCase();
                dkimStatusEl.className = `text-2xl font-bold ${isPass ? 'text-green-400' : 'text-red-400 failure-badge'}`;
            } else {
                dkimStatusEl.textContent = 'N/A';
                dkimStatusEl.className = 'text-2xl font-bold text-gray-500';
            }

            // Timeline
            const timelineContainer = document.getElementById('timelineContainer');
            timelineContainer.innerHTML = '';

            hops.forEach((hop, index) => {
                const isFailure = (index === 0 && spfResult && spfResult !== 'pass') || 
                                 (index === 0 && dkimResult && dkimResult !== 'pass');
                
                // Add arrow between hops
                if (index > 0) {
                    const arrow = document.createElement('div');
                    arrow.className = 'flex justify-center my-2';
                    arrow.innerHTML = `
                        <div class="text-obsidian-accent text-xl">
                            <i class="fa-solid fa-arrow-down"></i>
                        </div>
                    `;
                    timelineContainer.appendChild(arrow);
                }
                
                const hopCard = document.createElement('div');
                hopCard.className = `hop-card bg-[#111827] border ${isFailure ? 'border-red-500' : 'border-obsidian-border'} rounded-lg p-4 relative`;
                
                const timeInfo = hop.timeAtPrevious !== undefined 
                    ? `<div class="text-xs text-obsidian-accent font-mono mb-2">
                        <i class="fa-solid fa-clock mr-1"></i>
                        ${formatTime(hop.timeAtPrevious)} at previous server
                       </div>`
                    : index === 0 
                        ? '<div class="text-xs text-gray-500 font-mono mb-2">Origin</div>'
                        : '';

                hopCard.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xs bg-obsidian-accent text-white px-2 py-1 rounded font-mono">Hop ${index + 1}</span>
                                ${isFailure ? '<span class="text-xs bg-red-500 text-white px-2 py-1 rounded failure-badge">AUTH FAILURE</span>' : ''}
                            </div>
                            <div class="text-white font-semibold mb-1">${hop.server}</div>
                            ${hop.ip ? `<div class="text-xs text-gray-400 font-mono">${hop.ip}</div>` : ''}
                            ${timeInfo}
                            <div class="text-xs text-gray-500 font-mono mt-2">${formatDate(hop.timestamp)}</div>
                        </div>
                        <div class="text-obsidian-accent text-2xl">
                            <i class="fa-solid fa-server"></i>
                        </div>
                    </div>
                `;
                
                timelineContainer.appendChild(hopCard);
            });

            // Hop Details
            const hopDetails = document.getElementById('hopDetails');
            hopDetails.innerHTML = '';

            hops.forEach((hop, index) => {
                const detailCard = document.createElement('div');
                detailCard.className = 'bg-[#111827] border border-obsidian-border rounded p-4 font-mono text-xs';
                
                detailCard.innerHTML = `
                    <div class="flex items-start justify-between mb-2">
                        <span class="text-obsidian-accent font-semibold">Hop ${index + 1}: ${hop.server}</span>
                        ${hop.timeAtPrevious !== undefined 
                            ? `<span class="text-green-400">${formatTime(hop.timeAtPrevious)}</span>`
                            : '<span class="text-gray-500">Origin</span>'}
                    </div>
                    <div class="text-gray-400 whitespace-pre-wrap break-all">${hop.raw}</div>
                `;
                
                hopDetails.appendChild(detailCard);
            });

            // Authentication Results
            if (authResults) {
                const authSection = document.getElementById('authSection');
                const authDetails = document.getElementById('authDetails');
                authSection.classList.remove('hidden');
                authDetails.innerHTML = `<div class="text-gray-300 whitespace-pre-wrap break-all">${authResults}</div>`;
            } else {
                document.getElementById('authSection').classList.add('hidden');
            }
        }
    </script>
</body>
</html>
