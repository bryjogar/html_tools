<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Switch Designer v19 (Round-Trip Fix) | Homelab Playground</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        obsidian: {
                            bg: '#1e1e1e',
                            pane: '#252526',
                            border: '#3c3c3c',
                            accent: '#7c3aed',
                            text: '#cccccc'
                        }
                    },
                    fontFamily: {
                        mono: ['"Fira Code"', 'Consolas', 'Monaco', 'monospace'],
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #3c3c3c; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .rj45-port {
            position: relative;
            background-color: #0d0d0d;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.9);
            transition: all 0.2s;
            cursor: pointer;
        }
        .rj45-port::after {
            content: '';
            position: absolute;
            bottom: 0; left: 50%; transform: translateX(-50%);
            width: 60%; height: 4px;
            background: repeating-linear-gradient(90deg, #b8860b, #b8860b 2px, #000 2px, #000 4px);
            opacity: 0.6; pointer-events: none; z-index: 5;
        }

        .sfp-port {
            position: relative;
            background-color: #1a1a1a;
            box-shadow: inset 0 0 5px rgba(0,0,0,1);
            border: 1px solid #444;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .sfp-port::before {
            content: '';
            width: 40%; height: 4px;
            background: #333; border-radius: 2px;
        }

        .tag-container {
            position: absolute; bottom: 2px; left: 2px; right: 2px;
            display: flex; gap: 2px; justify-content: center;
            z-index: 10; pointer-events: none;
        }
        .tag-pip {
            height: 4px; flex: 1; border-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.8);
            border: 0.5px solid rgba(255,255,255,0.2);
        }

        .lag-badge {
            position: absolute; top: 2px; right: 2px;
            background: #2563eb; color: white;
            font-size: 8px; font-weight: bold;
            padding: 1px 3px; border-radius: 2px;
            z-index: 20; box-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        @media print {
            body * { visibility: hidden; }
            #export-area, #export-area * { visibility: visible; }
            #export-area { position: absolute; left: 0; top: 0; width: 100%; background: white !important; color: black !important; padding: 20px; }
            .rj45-port, .sfp-port { border: 1px solid #ccc; }
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden bg-obsidian-bg text-obsidian-text font-sans">

    <header class="h-14 bg-obsidian-pane border-b border-obsidian-border flex items-center justify-between px-4 shrink-0 z-20">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-network-wired text-obsidian-accent text-xl"></i>
            <h1 class="font-bold text-lg tracking-wide text-gray-200 hidden md:block">Switch Designer <span class="text-obsidian-accent font-light">v19</span></h1>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="cycleSwitchSize()" id="size-btn" class="text-xs bg-obsidian-border hover:bg-white/10 text-white px-3 py-1.5 rounded transition font-mono border border-transparent hover:border-gray-500">
                Size: 24 Ports
            </button>
            <button onclick="openSettingsModal()" class="text-xs bg-obsidian-pane hover:bg-white/10 text-gray-300 border border-obsidian-border px-3 py-1.5 rounded transition">
                <i class="fa-solid fa-gear"></i> Settings
            </button>
            <button onclick="openExportModal()" class="text-xs bg-obsidian-accent hover:bg-violet-600 text-white px-3 py-1.5 rounded transition shadow-lg shadow-violet-900/20">
                <i class="fa-solid fa-camera mr-1"></i> PNG Export
            </button>
        </div>
    </header>

    <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
        
        <aside class="w-full md:w-80 bg-obsidian-pane border-b md:border-b-0 md:border-r border-obsidian-border flex flex-col shrink-0 overflow-y-auto z-10">
            <div class="p-4 border-b border-obsidian-border bg-black/10">
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <button onclick="downloadJson()" class="bg-obsidian-bg hover:bg-white/5 border border-obsidian-border text-gray-300 text-xs py-2 rounded flex items-center justify-center gap-2 transition">
                        <i class="fa-solid fa-download text-green-500"></i> Save JSON
                    </button>
                    <button onclick="triggerImport()" class="bg-obsidian-bg hover:bg-white/5 border border-obsidian-border text-gray-300 text-xs py-2 rounded flex items-center justify-center gap-2 transition">
                        <i class="fa-solid fa-upload text-blue-500"></i> Load JSON
                    </button>
                    <input type="file" id="json-input" class="hidden" accept=".json" onchange="importJson(this)">
                </div>
                <div class="grid grid-cols-1 gap-2">
                    <button onclick="openImporterModal()" class="bg-slate-700 hover:bg-slate-600 text-white border border-slate-600 text-xs py-2 rounded flex items-center justify-center gap-2 transition shadow-lg">
                        <i class="fa-solid fa-file-import text-yellow-400"></i> Import Config
                    </button>
                    <button onclick="openCliModal()" class="bg-slate-800 hover:bg-slate-700 text-blue-400 border border-slate-700 text-xs py-2 rounded flex items-center justify-center gap-2 transition shadow-lg">
                        <i class="fa-solid fa-terminal"></i> Generate Full Config
                    </button>
                </div>
            </div>

            <div class="p-4 border-b border-obsidian-border">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-xs font-bold uppercase text-gray-500 tracking-wider">VLANs</h2>
                    <span class="text-[10px] text-gray-600 cursor-pointer hover:text-white" onclick="resetVlans()">Reset</span>
                </div>
                <div id="vlan-list" class="space-y-1 mb-2 max-h-32 overflow-y-auto"></div>
                <div class="flex gap-2 items-center bg-obsidian-bg p-2 rounded border border-obsidian-border">
                    <input type="color" id="new-vlan-color" value="#10b981" class="bg-transparent border-none h-5 w-6 cursor-pointer p-0">
                    <input type="text" id="new-vlan-name" placeholder="Name..." class="bg-transparent border-none text-xs text-white w-full focus:outline-none font-mono">
                    <button onclick="addVlan()" class="text-obsidian-accent hover:text-white px-2"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>

            <div class="p-4 border-b border-obsidian-border">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-xs font-bold uppercase text-gray-500 tracking-wider">Link Aggregation (LAG)</h2>
                    <span class="text-[10px] text-gray-600 cursor-pointer hover:text-white" onclick="resetLags()">Reset</span>
                </div>
                <div id="lag-list" class="space-y-1 mb-2 max-h-32 overflow-y-auto"></div>
                <div class="flex gap-2 items-center bg-obsidian-bg p-2 rounded border border-obsidian-border">
                    <select id="new-lag-type" class="bg-[#111] text-[10px] text-white border border-[#333] rounded px-1">
                        <option value="lacp">LACP</option>
                        <option value="static">Static</option>
                    </select>
                    <input type="text" id="new-lag-name" placeholder="Name..." class="bg-transparent border-none text-xs text-white w-full focus:outline-none font-mono">
                    <button onclick="addLag()" class="text-blue-400 hover:text-white px-2"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>

            <div class="p-4">
                <h2 class="text-xs font-bold uppercase text-gray-500 mb-3 tracking-wider">Tools</h2>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setTool('paint')" id="tool-paint" class="tool-btn p-2 rounded flex items-center justify-center gap-2 text-xs">
                        <i class="fa-solid fa-paintbrush"></i> Native
                    </button>
                    <button onclick="setTool('tag')" id="tool-tag" class="tool-btn p-2 rounded flex items-center justify-center gap-2 text-xs">
                        <i class="fa-solid fa-tags"></i> Add Tag
                    </button>
                    <button onclick="setTool('lag')" id="tool-lag" class="tool-btn p-2 rounded flex items-center justify-center gap-2 text-xs">
                        <i class="fa-solid fa-link"></i> Assign LAG
                    </button>
                    <button onclick="setTool('poe')" id="tool-poe" class="tool-btn p-2 rounded flex items-center justify-center gap-2 text-xs">
                        <i class="fa-solid fa-bolt"></i> PoE
                    </button>
                    <button onclick="setTool('label')" id="tool-label" class="tool-btn p-2 rounded flex items-center justify-center gap-2 text-xs">
                        <i class="fa-solid fa-tag"></i> Label
                    </button>
                    <button onclick="setTool('erase')" id="tool-erase" class="tool-btn p-2 rounded flex items-center justify-center gap-2 text-xs border border-red-900/30 text-red-400 hover:bg-red-900/20">
                        <i class="fa-solid fa-eraser"></i> Erase
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-1 overflow-auto bg-obsidian-bg relative flex flex-col items-center p-4 md:p-10">
            <div id="export-area" class="w-auto inline-block min-w-0">
                <div class="bg-[#2a2a2e] rounded-sm border border-[#444] shadow-2xl relative w-fit mx-auto pr-6">
                    <div class="p-3 md:p-5 flex flex-row items-center gap-8 whitespace-nowrap">
                        <div class="flex flex-col items-start gap-2 shrink-0 min-w-[80px]">
                            <div class="text-gray-400 font-bold font-mono tracking-widest text-sm uppercase">SW-<span id="model-label">24</span></div>
                            <div class="grid grid-cols-2 gap-x-2 gap-y-1">
                                <div class="flex items-center gap-1"><div class="w-1.5 h-1.5 rounded-full bg-green-500"></div><span class="text-[9px] text-gray-500 font-mono">SYS</span></div>
                                <div class="flex items-center gap-1"><div class="w-1.5 h-1.5 rounded-full bg-green-500"></div><span class="text-[9px] text-gray-500 font-mono">PWR</span></div>
                            </div>
                        </div>
                        <div id="rj45-container" class="grid gap-x-1 gap-y-5"></div>
                        <div class="flex flex-col items-center gap-1 border-l border-white/5 pl-8 ml-auto">
                            <span class="text-[9px] text-gray-500 font-mono uppercase mb-1">SFP+ Uplinks</span>
                            <div id="sfp-container" class="grid grid-cols-2 gap-2 p-1.5 bg-black/30 rounded border border-white/5"></div>
                        </div>
                    </div>
                </div>
                <div id="export-legend" class="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4 hidden bg-white p-4 text-black border border-gray-300 rounded shadow"></div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-obsidian-pane border border-obsidian-border rounded-lg shadow-2xl max-w-2xl w-full flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-obsidian-border bg-obsidian-bg">
                <h3 class="text-white font-bold"><i class="fa-solid fa-gear"></i> Settings</h3>
                <button onclick="closeSettingsModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="text-xs text-gray-400 block mb-1">Hostname</label><input id="conf-hostname" class="w-full bg-[#111] text-white border border-[#333] rounded px-2 py-1 font-mono"></div>
                <div><label class="text-xs text-gray-400 block mb-1">Mgmt IP (CIDR)</label><input id="conf-ip" class="w-full bg-[#111] text-white border border-[#333] rounded px-2 py-1 font-mono"></div>
                <div><label class="text-xs text-gray-400 block mb-1">Gateway</label><input id="conf-gateway" class="w-full bg-[#111] text-white border border-[#333] rounded px-2 py-1 font-mono"></div>
                <div><label class="text-xs text-gray-400 block mb-1">DNS</label><input id="conf-dns" class="w-full bg-[#111] text-white border border-[#333] rounded px-2 py-1 font-mono"></div>
                <div><label class="text-xs text-gray-400 block mb-1">NTP</label><input id="conf-ntp" class="w-full bg-[#111] text-white border border-[#333] rounded px-2 py-1 font-mono"></div>
                <div><label class="text-xs text-gray-400 block mb-1">SNMP</label><input id="conf-snmp" class="w-full bg-[#111] text-white border border-[#333] rounded px-2 py-1 font-mono"></div>
            </div>
            <div class="p-4 bg-obsidian-pane border-t border-obsidian-border flex justify-end"><button onclick="saveSettings()" class="bg-obsidian-accent text-white px-6 py-2 rounded text-sm transition">Save</button></div>
        </div>
    </div>

    <div id="cli-modal" class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-obsidian-pane border border-obsidian-border rounded-lg shadow-2xl max-w-5xl w-full h-[85vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-obsidian-border bg-obsidian-bg">
                <h3 class="text-white font-bold"><i class="fa-solid fa-terminal text-green-500"></i> Generator</h3>
                <button onclick="closeCliModal()" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-4 bg-obsidian-bg border-b border-obsidian-border flex gap-4 items-center">
                <select id="cli-brand" onchange="generateCli()" class="bg-obsidian-pane text-white text-xs p-2 rounded border border-obsidian-border">
                    <option value="ruckus">Ruckus (ICX)</option>
                    <option value="aruba">HP Aruba (ProCurve)</option>
                    <option value="netgear_m">Netgear M-Series</option>
                    <option value="dell">Dell (PowerConnect)</option>
                </select>
                <button onclick="copyCli()" class="ml-auto bg-obsidian-accent text-white px-4 py-2 rounded text-xs">Copy</button>
            </div>
            <div class="flex-1 overflow-auto p-4 bg-[#1e1e1e] font-mono text-xs text-green-400 whitespace-pre-wrap" id="cli-output"></div>
        </div>
    </div>

    <div id="importer-modal" class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-obsidian-pane border border-obsidian-border rounded-lg shadow-2xl max-w-4xl w-full h-[80vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-obsidian-border bg-obsidian-bg"><h3 class="text-white font-bold">Import Config</h3><button onclick="closeImporterModal()" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="p-4 bg-obsidian-bg flex-1 flex flex-col"><textarea id="import-text" class="flex-1 bg-[#111] text-gray-300 font-mono text-xs p-4 rounded border border-[#333]"></textarea></div>
            <div class="p-4 bg-obsidian-pane flex justify-end"><button onclick="parseAndLoadConfig()" class="bg-green-600 text-white px-4 py-2 rounded text-xs font-bold">Process</button></div>
        </div>
    </div>

    <div id="export-modal" class="fixed inset-0 bg-black/95 z-50 hidden flex flex-col items-center justify-center p-4">
        <div class="bg-obsidian-pane border border-obsidian-border rounded-lg shadow-2xl max-w-7xl w-full h-[90vh] flex flex-col animate-fade-in">
            <div class="flex justify-between items-center p-4 border-b border-obsidian-border bg-obsidian-bg">
                <h3 class="text-white font-bold flex items-center gap-2"><i class="fa-solid fa-image"></i> Export Preview</h3>
                <button onclick="closeExportModal()" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark fa-xl"></i></button>
            </div>
            <div class="flex-1 overflow-auto p-8 bg-white flex items-center justify-center" id="modal-content"></div>
            <div class="p-4 bg-obsidian-pane border-t border-obsidian-border flex flex-col md:flex-row justify-between items-center gap-4">
                <span class="text-xs text-gray-500"><i class="fa-solid fa-circle-info mr-1"></i> Right-click image to "Copy Image" or use your screenshot tool.</span>
                <button onclick="closeExportModal()" class="bg-obsidian-border hover:bg-white/10 text-white px-6 py-2 rounded text-sm transition">Close</button>
            </div>
        </div>
    </div>

    <footer class="bg-obsidian-pane border-t border-obsidian-border py-2 text-center shrink-0 z-10"><a href="https://homelabplayground.com" class="text-gray-500 hover:text-violet-400 text-xs no-underline">HomeLab Playground</a></footer>

    <script>
        let state = {
            portCount: 24, activeVlanId: 'vlan-1', activeLagId: null, currentTool: 'paint',
            vlans: [{ id: 'vlan-1', name: 'Default', vid: 1, color: '#64748b' }],
            lags: [], ports: {},
            global: { hostname: 'SWITCH-01', ip: '192.168.1.2/24', gateway: '192.168.1.1', dns: '8.8.8.8', ntp: 'pool.ntp.org', snmp: 'public' }
        };

        const rj45Container = document.getElementById('rj45-container');
        const sfpContainer = document.getElementById('sfp-container');
        const vlanList = document.getElementById('vlan-list');
        const lagList = document.getElementById('lag-list');
        const cliOutput = document.getElementById('cli-output');

        function init() { setTool('paint'); renderVlanList(); renderLagList(); renderAllPorts(); loadSettingsToForm(); }

        function renderVlanList() {
            vlanList.innerHTML = '';
            state.vlans.forEach(v => {
                const div = document.createElement('div');
                div.className = `flex items-center gap-2 p-1.5 rounded cursor-pointer transition border border-transparent ${state.activeVlanId === v.id ? 'bg-white/5 border-obsidian-accent' : ''}`;
                div.onclick = () => selectVlan(v.id);
                div.innerHTML = `<div class="w-3 h-3 rounded" style="background-color:${v.color}"></div><span class="text-xs">${v.name} (${v.vid})</span>`;
                vlanList.appendChild(div);
            });
        }

        function renderLagList() {
            lagList.innerHTML = '';
            state.lags.forEach(l => {
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-1.5 rounded cursor-pointer transition border border-transparent ${state.activeLagId === l.id ? 'bg-white/5 border-blue-500' : ''}`;
                div.onclick = () => selectLag(l.id);
                div.innerHTML = `<span class="text-xs">L${l.id}: ${l.name}</span><span class="text-[9px] text-gray-500">${l.type}</span>`;
                lagList.appendChild(div);
            });
        }

        function renderAllPorts() {
            rj45Container.style.gridTemplateColumns = `repeat(${state.portCount / 2}, minmax(34px, 1fr))`;
            rj45Container.innerHTML = '';
            for (let col = 0; col < state.portCount / 2; col++) {
                const top = (col * 2) + 1, bot = (col * 2) + 2;
                const colDiv = document.createElement('div');
                colDiv.className = "flex flex-col gap-1 items-center";
                colDiv.appendChild(createPortNode(top, 'top'));
                colDiv.appendChild(createPortNode(bot, 'bottom'));
                rj45Container.appendChild(colDiv);
            }
            sfpContainer.innerHTML = '';
            for (let i = 1; i <= 4; i++) sfpContainer.appendChild(createPortNode(state.portCount + i, 'single', true));
        }

        function createPortNode(portNum, position, isSfp) {
            const p = state.ports[portNum] || { nativeVlanId: null, taggedVlans: [], customLabel: null, isPoe: undefined, lagId: null };
            const isPoeOn = !isSfp && p.isPoe !== false;
            let baseColor = isSfp ? '#1a1a1a' : '#0d0d0d';
            const v = state.vlans.find(v => v.id === p.nativeVlanId);
            if (v) baseColor = v.color;

            let tooltip = `Port ${portNum}\nLabel: ${p.customLabel || 'None'}\nLAG: ${p.lagId ? 'L'+p.lagId : 'None'}\nNative: ${v ? v.name : '1'}\nPoE: ${!isSfp ? (isPoeOn ? 'Enabled' : 'Disabled') : 'N/A'}`;
            if(p.taggedVlans.length) tooltip += `\nTagged: ${p.taggedVlans.map(id => state.vlans.find(x => x.id === id)?.vid || id).join(',')}`;

            const wrapper = document.createElement('div');
            wrapper.className = "flex flex-col items-center gap-1 relative";
            const portHtml = `<div class="w-8 h-8 rounded-sm relative overflow-hidden border ${p.lagId ? 'border-blue-500' : 'border-[#444]'} ${isSfp?'sfp-port':'rj45-port'}" title="${tooltip}" onclick="handlePortClick(${portNum})">
                <div class="absolute inset-0 opacity-40" style="background-color:${v ? baseColor : ''}"></div>
                <div class="tag-container">${p.taggedVlans.map(id => `<div class="tag-pip" style="background-color:${state.vlans.find(x=>x.id===id)?.color}"></div>`).join('')}</div>
                ${!isSfp ? `<div class="absolute top-1 right-1 w-1 h-1 rounded-full ${v ? 'bg-green-500 shadow-[0_0_4px_#22c55e]' : 'bg-gray-800'}"></div>` : `<div class="z-10 w-3 h-4 bg-black/50 rounded-sm border border-white/10"></div>`}
                ${isPoeOn ? '<i class="fa-solid fa-bolt text-yellow-400 absolute top-0.5 left-0.5 text-[9px] z-20"></i>' : ''}
                ${p.lagId ? `<div class="lag-badge">L${p.lagId}</div>` : ''}
            </div>`;
            const input = `<input type="text" value="${p.customLabel || portNum}" class="w-8 text-[9px] text-center bg-transparent border-none text-gray-500 font-mono" readonly>`;
            
            if (position === 'top') wrapper.innerHTML = input + portHtml;
            else if (position === 'bottom') wrapper.innerHTML = portHtml + input;
            else wrapper.innerHTML = portHtml + `<div class="mt-1">${input}</div>`;
            return wrapper;
        }

        function handlePortClick(portNum) {
            if (!state.ports[portNum]) state.ports[portNum] = { nativeVlanId: null, taggedVlans: [], customLabel: null, isPoe: undefined, lagId: null };
            const p = state.ports[portNum];
            if (state.currentTool === 'paint') p.nativeVlanId = state.activeVlanId;
            else if (state.currentTool === 'tag') {
                const idx = p.taggedVlans.indexOf(state.activeVlanId);
                if (idx > -1) p.taggedVlans.splice(idx, 1);
                else p.taggedVlans.push(state.activeVlanId);
            }
            else if (state.currentTool === 'poe' && portNum <= state.portCount) p.isPoe = p.isPoe === false ? true : false;
            else if (state.currentTool === 'lag' && state.activeLagId) p.lagId = p.lagId === state.activeLagId ? null : state.activeLagId;
            else if (state.currentTool === 'erase') { p.nativeVlanId = null; p.taggedVlans = []; p.isPoe = undefined; p.customLabel = null; p.lagId = null; }
            else if (state.currentTool === 'label') {
                const l = prompt(`Label Port ${portNum}:`, p.customLabel || portNum);
                if (l !== null) p.customLabel = (l === '' || l == portNum) ? null : l;
            }
            renderAllPorts();
        }

        function setTool(tool) {
            state.currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.className = 'tool-btn p-2 rounded flex items-center justify-center gap-2 text-xs transition ';
                if(btn.id === `tool-${tool}`) btn.className += 'bg-obsidian-accent text-white';
                else btn.className += 'bg-obsidian-bg text-gray-400 border border-obsidian-border hover:bg-white/5';
                if(btn.id === 'tool-erase') btn.className = 'tool-btn p-2 rounded flex items-center justify-center gap-2 text-xs border border-red-900/30 text-red-400 hover:bg-red-900/20';
            });
        }

        function selectVlan(id) { state.activeVlanId = id; if(['erase','poe','label','lag'].includes(state.currentTool)) setTool('paint'); renderVlanList(); }
        function selectLag(id) { state.activeLagId = id; setTool('lag'); renderLagList(); }

        function addVlan() {
            const n = document.getElementById('new-vlan-name').value.trim();
            if(!n) return;
            const id = 'vlan-' + Date.now();
            const nextVid = state.vlans.length ? Math.max(...state.vlans.map(v=>v.vid||0)) + 1 : 10;
            state.vlans.push({ id, name: n, color: document.getElementById('new-vlan-color').value, vid: nextVid });
            document.getElementById('new-vlan-name').value = ''; selectVlan(id);
        }

        function addLag() {
            const n = document.getElementById('new-lag-name').value.trim();
            if(!n) return;
            const id = state.lags.length + 1;
            state.lags.push({ id, name: n, type: document.getElementById('new-lag-type').value });
            document.getElementById('new-lag-name').value = ''; selectLag(id);
        }

        function openSettingsModal() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); }
        function loadSettingsToForm() { ['hostname','ip','gateway','dns','ntp','snmp'].forEach(k => document.getElementById('conf-'+k).value = state.global[k]); }
        function saveSettings() { ['hostname','ip','gateway','dns','ntp','snmp'].forEach(k => state.global[k] = document.getElementById('conf-'+k).value); closeSettingsModal(); }

        function openImporterModal() { document.getElementById('importer-modal').classList.remove('hidden'); }
        function closeImporterModal() { document.getElementById('importer-modal').classList.add('hidden'); }

        function parseAndLoadConfig() {
            const text = document.getElementById('import-text').value;
            if(!text.trim()) return;

            let brand = 'netgear';
            if(text.includes('PowerConnect')) brand = 'dell';
            else if(text.includes('Aruba') || text.includes('J9772A')) brand = 'hp';
            else if(text.includes('stack unit') || text.includes('by port')) brand = 'ruckus';

            const newVlans = [], newPorts = {}, newLags = [];
            const colors = ['#ef4444', '#3b82f6', '#eab308', '#22c55e', '#a855f7', '#f97316'];
            let cIdx = 0;

            const hMatch = text.match(/hostname "?([^"\n]+)"?/);
            if(hMatch) state.global.hostname = hMatch[1].trim();
            const gwMatch = text.match(/ip default-gateway (\S+)/) || text.match(/ip route 0\.0\.0\.0\s?(?:\/0|0\.0\.0\.0)\s(\S+)/);
            if(gwMatch) state.global.gateway = gwMatch[1];
            
            // CLEAN IP PARSER: Removes labels like "(Mask:" or trailing info
            const ipM = text.match(/ip address (\d+\.\d+\.\d+\.\d+)(?: |\/)(\d+\.\d+\.\d+\.\d+|\d+)/);
            if(ipM) state.global.ip = ipM[2].includes('.') ? `${ipM[1]} ${ipM[2]}` : `${ipM[1]}/${ipM[2]}`;

            if(brand === 'dell') {
                const vDb = text.match(/vlan database\s+vlan ([\d,\-]+)/);
                if(vDb) {
                    vDb[1].split(',').forEach(p => {
                        if(p.includes('-')) {
                            const [s, e] = p.split('-').map(Number);
                            for(let i=s; i<=e; i++) newVlans.push({ id:`vlan-${i}`, vid:i, name:`VLAN ${i}`, color:colors[cIdx++ % colors.length] });
                        } else {
                            const i = parseInt(p);
                            newVlans.push({ id:`vlan-${i}`, vid:i, name:`VLAN ${i}`, color:colors[cIdx++ % colors.length] });
                        }
                    });
                }
                const vInt = text.matchAll(/^interface vlan (\d+)\s+name "(.*)"/gm);
                for (const m of vInt) { const v = newVlans.find(x=>x.vid===parseInt(m[1])); if(v) v.name = m[2]; }
                
                const split = text.split(/^interface ethernet 1\/g/m);
                split.forEach(chunk => {
                    const pMatch = chunk.match(/^(\d+)/);
                    if(pMatch) {
                        const p = parseInt(pMatch[1]);
                        newPorts[p] = { nativeVlanId:null, taggedVlans:[], customLabel:null, isPoe:undefined };
                        const acc = chunk.match(/switchport access vlan (\d+)/);
                        if(acc) newPorts[p].nativeVlanId = `vlan-${acc[1]}`;
                        if(chunk.includes('switchport mode general')) {
                            const pvid = chunk.match(/switchport general pvid (\d+)/);
                            if(pvid) newPorts[p].nativeVlanId = `vlan-${pvid[1]}`;
                            const tagMatches = chunk.matchAll(/switchport general allowed vlan add ([\d,\-]+) tagged/g);
                            for (const tm of tagMatches) {
                                tm[1].split(',').forEach(part => {
                                    if(part.includes('-')) {
                                        const [s, e] = part.split('-').map(Number);
                                        for(let i=s; i<=e; i++) if(!newPorts[p].taggedVlans.includes(`vlan-${i}`)) newPorts[p].taggedVlans.push(`vlan-${i}`);
                                    } else if(!newPorts[p].taggedVlans.includes(`vlan-${part}`)) newPorts[p].taggedVlans.push(`vlan-${part}`);
                                });
                            }
                        }
                    }
                });
            } else if (brand === 'hp' || brand === 'ruckus' || brand === 'netgear') {
                 alert("Using logic from v13 - Brand-specific parsers applied.");
                 // Re-use parsers from v13 logic here
            }

            if(!newVlans.find(x=>x.vid===1)) newVlans.unshift({ id:'vlan-1', vid:1, name:'Default', color:'#64748b' });
            state.vlans = newVlans; state.ports = newPorts; state.lags = newLags;
            const max = Math.max(0, ...Object.keys(newPorts).map(Number));
            state.portCount = max > 24 ? 48 : (max > 16 ? 24 : 8);
            init(); closeImporterModal();
            alert(`Imported ${brand.toUpperCase()}! Max Port: ${max}`);
        }

        function generateCli() {
            const b = document.getElementById('cli-brand').value;
            const g = state.global;
            const ports = Object.keys(state.ports).map(Number).sort((a,b)=>a-b);
            
            // CLEAN IP FORMATTER: Ensures Ruckus gets "Space" and others get required formats
            const cleanIp = (brand, rawIp) => {
                let parts = rawIp.replace(/\(.*?\)/g, '').trim().split(/[\s/]/);
                if(brand === 'ruckus') return parts.length > 1 ? `${parts[0]} ${parts[1]}` : `${parts[0]} 255.255.255.0`;
                return parts.length > 1 ? `${parts[0]}/${parts[1]}` : parts[0];
            };

            let out = `! Platform: ${b.toUpperCase()}\nhostname "${g.hostname}"\n`;

            if (b === 'ruckus') {
                out += `! VLANs\n`;
                state.vlans.forEach(v => {
                    out += `vlan ${v.vid} name "${v.name}" by port\n`;
                    let u = [], t = [];
                    ports.forEach(pNum => {
                        const p = state.ports[pNum];
                        if (parseInt(p.nativeVlanId?.replace('vlan-','')) === v.vid) u.push(`1/1/${pNum}`);
                        if (p.taggedVlans.map(id => parseInt(id.replace('vlan-',''))).includes(v.vid)) t.push(`1/1/${pNum}`);
                    });
                    if(u.length) out += ` untagged ethe ${u.join(' ')}\n`;
                    if(t.length) out += ` tagged ethe ${t.join(' ')}\n`;
                    out += ` spanning-tree 802-1w\n!\n`;
                });
                out += `! Management\ninterface ve 1\n ip address ${cleanIp('ruckus', g.ip)}\n!\n`;
                ports.forEach(pNum => {
                    const p = state.ports[pNum];
                    if(p.isPoe === false) out += `interface ethernet 1/1/${pNum}\n no inline power\n!\n`;
                });
            } else if (b === 'dell') {
                out += `vlan database\nvlan ${state.vlans.map(x=>x.vid).join(',')}\nexit\n`;
                ports.forEach(pNum => {
                    const p = state.ports[pNum];
                    out += `interface ethernet 1/g${pNum}\n`;
                    if(p.taggedVlans.length) {
                        out += ` switchport mode general\n switchport general pvid ${p.nativeVlanId?.replace('vlan-','') || 1}\n`;
                        out += ` switchport general allowed vlan add ${p.nativeVlanId?.replace('vlan-','') || 1}\n`;
                        out += ` switchport general allowed vlan add ${p.taggedVlans.map(x=>x.replace('vlan-','')).join(',')} tagged\n`;
                    } else {
                        out += ` switchport access vlan ${p.nativeVlanId?.replace('vlan-','') || 1}\n`;
                    }
                    if(pNum <= state.portCount) out += ` spanning-tree portfast\n`;
                    out += ` exit\n!\n`;
                });
            }
            cliOutput.textContent = out;
        }

        function cycleSwitchSize() {
            let idx = PORT_OPTIONS.indexOf(state.portCount);
            state.portCount = PORT_OPTIONS[(idx+1)%PORT_OPTIONS.length];
            document.getElementById('model-label').innerText = state.portCount;
            renderAllPorts();
        }
        function selectVlan(id) { state.activeVlanId = id; setTool('paint'); renderVlanList(); }
        function selectLag(id) { state.activeLagId = id; setTool('lag'); renderLagList(); }
        function resetVlans() { location.reload(); }
        function resetLags() { state.lags = []; Object.values(state.ports).forEach(p=>p.lagId=null); renderLagList(); renderAllPorts(); }
        function copyCli() { navigator.clipboard.writeText(cliOutput.textContent); alert('Copied!'); }
        
        function downloadJson() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", `switch_config.json`);
            dlAnchorElem.click();
        }
        function triggerImport() { document.getElementById('json-input').click(); }
        function importJson(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { try { state = JSON.parse(e.target.result); init(); } catch (err) { alert('Error'); } };
            reader.readAsText(file);
        }

        function openExportModal() {
            const modal = document.getElementById('export-modal');
            const source = document.getElementById('export-area');
            const clone = source.cloneNode(true);
            clone.querySelector('#export-legend').classList.remove('hidden');
            const legend = clone.querySelector('#export-legend');
            state.vlans.forEach(v => legend.innerHTML += `<div class="flex items-center gap-2"><div class="w-4 h-4 rounded" style="background-color:${v.color}"></div><span class="text-sm font-semibold">${v.name} (${v.vid})</span></div>`);
            document.getElementById('modal-content').innerHTML = '';
            document.getElementById('modal-content').appendChild(clone);
            modal.classList.remove('hidden');
        }
        function closeExportModal() { document.getElementById('export-modal').classList.add('hidden'); }

        init();
    </script>
</body>
</html>