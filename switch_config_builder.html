<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Config Builder - Multi-Step</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        obsidian: {
                            bg: '#1e1e1e',       // Main background
                            pane: '#252526',     // Headers/Panels
                            border: '#3c3c3c',   // Borders
                            accent: '#7c3aed',   // Violet Primary
                            success: '#10b981',  // Green for "Add"
                            text: '#cccccc',     // Standard Text
                            code: '#111111'      // Code block background
                        }
                    },
                    fontFamily: {
                        mono: ['"Fira Code"', 'Consolas', 'Monaco', 'monospace'],
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #3c3c3c; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b4b4b; }

        /* Syntax Highlighting */
        .token-cmd { color: #c586c0; font-weight: bold; } /* Keywords */
        .token-param { color: #9cdcfe; } /* Parameters */
        .token-num { color: #b5cea8; }   /* Numbers */
        .token-comment { color: #6a9955; font-style: italic; } /* Comments */
        
        /* Master Textarea Styling */
        #masterBuild {
            font-family: 'Fira Code', 'Consolas', monospace;
            line-height: 1.5;
            resize: none;
        }
        #masterBuild:focus {
            outline: none;
            background-color: #0d0d0d;
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden bg-obsidian-bg text-obsidian-text font-sans">

    <header class="h-14 bg-obsidian-pane border-b border-obsidian-border flex items-center justify-between px-4 shrink-0 z-20">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-layer-group text-obsidian-accent text-xl"></i>
            <h1 class="font-bold text-lg tracking-wide text-white hidden md:block">Config<span class="text-obsidian-accent">Stacker</span></h1>
        </div>
        
        <div class="flex bg-obsidian-bg rounded-lg p-1 border border-obsidian-border">
            <button id="btn-ruckus" onclick="setVendor('ruckus')" class="w-24 py-1.5 text-xs rounded transition-all font-mono font-bold text-white bg-obsidian-accent shadow-lg shadow-purple-900/20">
                RUCKUS
            </button>
            <button id="btn-aruba" onclick="setVendor('aruba')" class="w-24 py-1.5 text-xs rounded transition-all font-mono hover:text-white text-gray-500">
                HP ARUBA
            </button>
        </div>
    </header>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        
        <section class="flex-1 flex flex-col border-b md:border-b-0 md:border-r border-obsidian-border overflow-y-auto bg-obsidian-bg custom-scrollbar z-10">
            <div class="p-6 space-y-6 max-w-2xl mx-auto w-full">
                
                <div class="flex items-center justify-between mb-2">
                    <label class="text-xs uppercase tracking-wider text-gray-500 font-bold">1. Select Feature</label>
                </div>
                
                <div class="relative">
                    <select id="featureSelect" onchange="renderInputs()" class="w-full bg-obsidian-pane border border-obsidian-border text-white px-4 py-3 rounded appearance-none cursor-pointer focus:border-obsidian-accent focus:outline-none transition-colors">
                        </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-obsidian-accent">
                        <i class="fa-solid fa-chevron-down text-xs"></i>
                    </div>
                </div>

                <div id="dynamicInputs" class="space-y-4 pt-2">
                    </div>
            </div>
        </section>

        <section class="flex-1 flex flex-col bg-obsidian-bg overflow-hidden relative border-l border-obsidian-border">
            
            <div class="h-2/5 flex flex-col border-b border-obsidian-border bg-obsidian-code">
                <div class="h-9 bg-obsidian-pane border-b border-obsidian-border flex items-center justify-between px-3 shrink-0">
                    <span class="text-[10px] font-mono text-gray-400 uppercase tracking-wider"><i class="fa-solid fa-magnifying-glass mr-1"></i> Preview Snippet</span>
                    <span id="currentFeatureName" class="text-[10px] font-mono text-obsidian-accent"></span>
                </div>
                
                <div class="flex-1 overflow-auto p-3 custom-scrollbar relative">
                    <pre class="font-mono text-xs leading-relaxed whitespace-pre-wrap text-gray-300"><code id="previewOutput">...</code></pre>
                </div>

                <div class="p-2 bg-obsidian-pane border-t border-obsidian-border flex justify-end">
                    <button onclick="appendToMaster()" class="bg-obsidian-accent hover:bg-violet-500 text-white text-xs font-bold py-2 px-4 rounded shadow-lg shadow-purple-900/20 transition-all flex items-center gap-2 active:scale-95">
                        <i class="fa-solid fa-plus-circle"></i> Append to Build
                    </button>
                </div>
            </div>

            <div class="flex-1 flex flex-col bg-[#0f0f0f]">
                <div class="h-10 bg-[#1a1a1a] border-b border-obsidian-border flex items-center justify-between px-3 shrink-0">
                    <span class="text-[10px] font-mono text-gray-400 uppercase tracking-wider flex items-center gap-2">
                        <i class="fa-solid fa-file-code"></i> Master Build
                        <span id="lineCount" class="bg-gray-800 text-gray-400 px-1.5 rounded text-[9px]">0 lines</span>
                    </span>
                    <div class="flex gap-2">
                        <button onclick="clearMaster()" class="text-[10px] text-red-400 hover:text-red-300 transition-colors uppercase font-bold tracking-wide px-2">
                            Clear
                        </button>
                        <button onclick="copyMaster()" class="text-[10px] bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded transition-colors uppercase font-bold tracking-wide flex items-center gap-1">
                            <i class="fa-regular fa-copy"></i> Copy All
                        </button>
                    </div>
                </div>

                <textarea id="masterBuild" class="flex-1 w-full bg-[#0f0f0f] text-gray-300 p-4 text-xs font-mono border-none focus:ring-0" 
                          spellcheck="false" 
                          placeholder="# Your accumulated configuration will appear here..."></textarea>
            </div>
        </section>

    </main>

    <footer class="bg-obsidian-pane border-t border-obsidian-border py-2 text-center shrink-0 z-10">
        <a href="https://homelabplayground.com" class="text-gray-500 hover:text-violet-400 text-xs transition-colors font-sans no-underline">
            HomeLab Playground
        </a>
    </footer>

    <script>
        // --- Configuration Templates ---
        const configData = {
            ruckus: {
                name: "Ruckus ICX",
                features: [
                    {
                        id: 'vlan_trunk',
                        name: 'VLAN Trunk (Tagged)',
                        template: 
`vlan {{vlan_ids}}
 tagged {{interface}}
 exit
write memory`
                    },
                    {
                        id: 'access_port',
                        name: 'Access Port (Untagged)',
                        template:
`vlan {{vlan_id}}
 untagged {{interface}}
 exit
write memory`
                    },
                    {
                        id: 'lacp_lag',
                        name: 'LACP LAG Setup',
                        template:
`lag "{{lag_name}}" dynamic id {{lag_id}}
 ports {{ports}}
 primary-port {{primary_port}}
 deploy
 exit
!
vlan {{vlan_ids}}
 tagged lag {{lag_id}}
 exit`
                    },
                    {
                        id: 've_interface',
                        name: 'Layer 3 VE (SVI)',
                        template:
`vlan {{vlan_id}}
 router-interface ve {{vlan_id}}
 exit
!
interface ve {{vlan_id}}
 ip address {{ip_address}} {{subnet_mask}}
 exit`
                    },
                    {
                        id: 'dhcp_snooping',
                        name: 'DHCP Snooping',
                        template:
`ip dhcp snooping vlan {{vlan_ids}}
!
interface {{uplink_port}}
 dhcp snooping trust
 exit`
                    }
                ]
            },
            aruba: {
                name: "HP Aruba (Provision)",
                features: [
                    {
                        id: 'vlan_trunk',
                        name: 'VLAN Trunk (Tagged)',
                        template:
`vlan {{vlan_ids}}
 tagged {{interface}}
 exit
write memory`
                    },
                    {
                        id: 'access_port',
                        name: 'Access Port (Untagged)',
                        template:
`vlan {{vlan_id}}
 untagged {{interface}}
 exit
write memory`
                    },
                    {
                        id: 'lacp_trunk',
                        name: 'LACP Trunk (Trk)',
                        template:
`trunk {{ports}} trk{{trunk_id}} lacp
!
vlan {{vlan_ids}}
 tagged trk{{trunk_id}}
 exit`
                    },
                    {
                        id: 'ip_interface',
                        name: 'VLAN IP Interface',
                        template:
`vlan {{vlan_id}}
 ip address {{ip_address}} {{subnet_mask}}
 exit`
                    },
                    {
                        id: 'mstp_priority',
                        name: 'MSTP Priority',
                        template:
`spanning-tree priority {{priority}}
spanning-tree force-version mstp-operation`
                    }
                ]
            }
        };

        // --- Metadata for Inputs ---
        const fieldMeta = {
            interface: { label: "Interface", placeholder: "e.g., ethernet 1/1/1", type: "text" },
            ports: { label: "Member Ports", placeholder: "e.g., 1/1/1 to 1/1/2", type: "text" },
            uplink_port: { label: "Uplink Port", placeholder: "e.g., 1/2/1", type: "text" },
            vlan_id: { label: "VLAN ID", placeholder: "e.g., 10", type: "number" },
            vlan_ids: { label: "VLAN ID List", placeholder: "e.g., 10,20,30", type: "text" },
            lag_name: { label: "LAG Name", placeholder: "e.g., Uplink_Core", type: "text" },
            lag_id: { label: "LAG ID", placeholder: "e.g., 1", type: "number" },
            trunk_id: { label: "Trunk Group ID", placeholder: "e.g., 1", type: "number" },
            primary_port: { label: "Primary Port", placeholder: "e.g., 1/1/1", type: "text" },
            ip_address: { label: "IP Address", placeholder: "e.g., 192.168.10.1", type: "text" },
            subnet_mask: { label: "Subnet Mask", placeholder: "e.g., 255.255.255.0", type: "text" },
            priority: { label: "STP Priority", placeholder: "0-15 (multiply by 4096)", type: "number" }
        };

        let currentVendor = 'ruckus';
        let currentRawTemplate = '';
        let currentRawSnippet = '';

        // --- Initialization ---
        window.onload = () => {
            populateFeatures();
        };

        function setVendor(vendor) {
            currentVendor = vendor;
            
            // Toggle UI classes
            const btnRuckus = document.getElementById('btn-ruckus');
            const btnAruba = document.getElementById('btn-aruba');
            
            const activeClass = "w-24 py-1.5 text-xs rounded transition-all font-mono font-bold text-white bg-obsidian-accent shadow-lg shadow-purple-900/20";
            const inactiveClass = "w-24 py-1.5 text-xs rounded transition-all font-mono hover:text-white text-gray-500";

            if (vendor === 'ruckus') {
                btnRuckus.className = activeClass;
                btnAruba.className = inactiveClass;
            } else {
                btnAruba.className = activeClass;
                btnRuckus.className = inactiveClass;
            }

            populateFeatures();
        }

        function populateFeatures() {
            const select = document.getElementById('featureSelect');
            select.innerHTML = '';
            
            configData[currentVendor].features.forEach(feat => {
                const opt = document.createElement('option');
                opt.value = feat.id;
                opt.innerText = feat.name;
                select.appendChild(opt);
            });

            renderInputs();
        }

        function renderInputs() {
            const select = document.getElementById('featureSelect');
            const featureId = select.value;
            const feature = configData[currentVendor].features.find(f => f.id === featureId);
            currentRawTemplate = feature.template;
            
            document.getElementById('currentFeatureName').innerText = feature.name;

            const container = document.getElementById('dynamicInputs');
            container.innerHTML = '';

            // Regex to find variables {{variable_name}}
            const regex = /{{(.*?)}}/g;
            let match;
            const foundVars = new Set();

            while ((match = regex.exec(currentRawTemplate)) !== null) {
                foundVars.add(match[1]);
            }

            foundVars.forEach(v => {
                const meta = fieldMeta[v] || { label: v, placeholder: "Value...", type: "text" };
                
                const wrapper = document.createElement('div');
                wrapper.innerHTML = `
                    <label class="block text-[10px] uppercase text-gray-400 mb-1 font-bold tracking-wider">${meta.label}</label>
                    <input type="${meta.type}" 
                           data-var="${v}" 
                           placeholder="${meta.placeholder}" 
                           oninput="updatePreview()"
                           class="w-full bg-[#141414] border border-obsidian-border text-white px-3 py-2 rounded text-xs font-mono focus:border-obsidian-accent focus:outline-none transition-colors placeholder-gray-700">
                `;
                container.appendChild(wrapper);
            });

            updatePreview();
        }

        function updatePreview() {
            let output = currentRawTemplate;
            const inputs = document.querySelectorAll('#dynamicInputs input');

            inputs.forEach(input => {
                const variable = input.getAttribute('data-var');
                const value = input.value;
                const regex = new RegExp(`{{${variable}}}`, 'g');
                output = output.replace(regex, value || `[${variable.toUpperCase()}]`);
            });

            currentRawSnippet = output; // Store raw text for appending

            // Highlighting for Preview
            const highlighted = highlightSyntax(output);
            document.getElementById('previewOutput').innerHTML = highlighted;
        }

        function appendToMaster() {
            const masterArea = document.getElementById('masterBuild');
            const featureName = document.getElementById('featureSelect').options[document.getElementById('featureSelect').selectedIndex].text;
            
            const timestamp = new Date().toLocaleTimeString();
            const header = `! --- [ ${featureName} ] @ ${timestamp} ---`;
            
            // If master is empty, don't add newline at start
            const prefix = masterArea.value.trim() === '' ? '' : '\n\n';
            
            masterArea.value += `${prefix}${header}\n${currentRawSnippet}`;
            
            // Scroll to bottom
            masterArea.scrollTop = masterArea.scrollHeight;
            updateLineCount();

            // Visual feedback
            const btn = document.querySelector('button[onclick="appendToMaster()"]');
            const oldText = btn.innerHTML;
            btn.className = "bg-obsidian-success text-white text-xs font-bold py-2 px-4 rounded shadow-lg transition-all flex items-center gap-2";
            btn.innerHTML = '<i class="fa-solid fa-check"></i> Added!';
            
            setTimeout(() => {
                btn.className = "bg-obsidian-accent hover:bg-violet-500 text-white text-xs font-bold py-2 px-4 rounded shadow-lg shadow-purple-900/20 transition-all flex items-center gap-2 active:scale-95";
                btn.innerHTML = oldText;
            }, 1000);
        }

        function clearMaster() {
            if(confirm("Clear the entire master configuration?")) {
                document.getElementById('masterBuild').value = "";
                updateLineCount();
            }
        }

        function copyMaster() {
            const code = document.getElementById('masterBuild').value;
            if(!code) return;
            
            navigator.clipboard.writeText(code).then(() => {
                const btn = document.querySelector('button[onclick="copyMaster()"]');
                const oldHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied';
                btn.classList.add('text-green-400');
                
                setTimeout(() => {
                    btn.innerHTML = oldHTML;
                    btn.classList.remove('text-green-400');
                }, 2000);
            });
        }

        function updateLineCount() {
            const lines = document.getElementById('masterBuild').value.split(/\r\n|\r|\n/).length;
            const text = document.getElementById('masterBuild').value.trim() === '' ? '0 lines' : `${lines} lines`;
            document.getElementById('lineCount').innerText = text;
        }

        function highlightSyntax(text) {
            let html = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            
            // Comments
            html = html.replace(/^(!.*$)/gm, '<span class="token-comment">$1</span>');

            // Keywords
            const keywords = ["vlan", "tagged", "untagged", "exit", "write", "memory", "lag", "dynamic", "id", "ports", "primary-port", "deploy", "trunk", "lacp", "ip", "address", "router-interface", "spanning-tree", "priority", "force-version"];
            keywords.forEach(kw => {
                const regex = new RegExp(`\\b${kw}\\b`, 'g');
                html = html.replace(regex, `<span class="token-cmd">${kw}</span>`);
            });

            // Numbers
            html = html.replace(/\b(\d+)\b/g, '<span class="token-num">$1</span>');

            return html;
        }
    </script>
</body>
</html>