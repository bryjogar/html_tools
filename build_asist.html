<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deck & Dock Planner Pro | Homelab Playground</title>
    <link rel="icon" type="image/png" href="https://homelabplayground.com/favicon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        obsidian: {
                            bg: '#1e1e1e',      // Main background
                            pane: '#252526',    // Headers/Panels
                            border: '#3c3c3c',  // Borders
                            accent: '#7c3aed',  // Violet Primary
                            text: '#cccccc'     // Standard Text
                        }
                    },
                    fontFamily: {
                        mono: ['"Fira Code"', 'Consolas', 'Monaco', 'monospace'],
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #252526; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Canvas Pattern */
        .canvas-bg {
            background-image: 
                linear-gradient(to right, #3c3c3c 1px, transparent 1px),
                linear-gradient(to bottom, #3c3c3c 1px, transparent 1px);
            background-size: 40px 40px; /* 40px = 1 foot scale */
            background-color: #1a1a1a;
        }
        /* Print specific styles */
        @media print {
            .no-print { display: none !important; }
            .canvas-bg { background-color: #fff !important; background-image: none !important; border: 1px solid #ddd; }
            body, aside, footer { background: #fff !important; color: #000 !important; height: auto !important; overflow: visible !important; }
            #canvas-container { overflow: visible !important; }
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden bg-obsidian-bg text-obsidian-text font-sans">

    <header class="h-14 bg-obsidian-pane border-b border-obsidian-border flex items-center justify-between px-4 shrink-0 z-20 no-print">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-compass-drafting text-obsidian-accent text-xl"></i>
            <h1 class="font-bold text-lg tracking-tight text-white">Deck & Dock Planner Pro</h1>
        </div>
        <div class="flex gap-2">
             <button onclick="resetView()" class="text-xs bg-obsidian-bg hover:bg-white/5 border border-obsidian-border px-3 py-1.5 rounded transition">
                <i class="fa-solid fa-crosshairs mr-1"></i> Center View
            </button>
            <button onclick="clearCanvas()" class="text-xs bg-red-900/20 hover:bg-red-900/50 text-red-400 border border-red-900/50 px-3 py-1.5 rounded transition">
                <i class="fa-solid fa-trash mr-1"></i> Clear
            </button>
        </div>
    </header>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        
        <aside class="w-full md:w-72 bg-obsidian-pane border-b md:border-b-0 md:border-r border-obsidian-border flex flex-col shrink-0 overflow-y-auto z-10 no-print">
            
            <div class="p-4 border-b border-obsidian-border bg-obsidian-bg/30">
                <h2 class="text-xs font-bold text-white mb-3 uppercase tracking-wider">
                    <i class="fa-solid fa-layer-group mr-1 text-obsidian-accent"></i> Views & Measurements
                </h2>
                
                <label class="flex items-center justify-between p-2 bg-obsidian-accent/10 border border-obsidian-accent/30 rounded cursor-pointer mb-4 hover:bg-obsidian-accent/20 transition">
                    <span class="text-xs font-bold text-white"><i class="fa-solid fa-ruler-combined mr-2"></i>Post Layout Mode</span>
                    <div class="relative inline-block w-10 h-5 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" id="toggle-post-coords" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer transition-transform duration-200 ease-in-out right-5 border-gray-600 checked:right-0 checked:border-obsidian-accent" onchange="togglePostMode()">
                        <label for="toggle-post-coords" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-600 cursor-pointer transition-colors duration-200 ease-in-out checked:bg-obsidian-accent"></label>
                    </div>
                </label>

                <div class="space-y-2" id="layer-toggles">
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-400"><i class="fa-solid fa-circle text-[8px] text-amber-900 mr-2"></i>Posts Layer</span>
                        <button onclick="toggleLayer('post')" id="btn-layer-post" class="text-xs px-2 py-0.5 rounded bg-obsidian-accent text-white"><i class="fa-solid fa-eye"></i></button>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-400"><i class="fa-solid fa-circle text-[8px] text-amber-600 mr-2"></i>Framing Layer</span>
                        <button onclick="toggleLayer('lumber')" id="btn-layer-lumber" class="text-xs px-2 py-0.5 rounded bg-obsidian-accent text-white"><i class="fa-solid fa-eye"></i></button>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-400"><i class="fa-solid fa-circle text-[8px] text-yellow-600 mr-2"></i>Decking Layer</span>
                        <button onclick="toggleLayer('decking')" id="btn-layer-decking" class="text-xs px-2 py-0.5 rounded bg-obsidian-accent text-white"><i class="fa-solid fa-eye"></i></button>
                    </div>
                </div>
            </div>

            <div class="p-4 border-b border-obsidian-border">
                <div class="bg-black/20 p-3 rounded border border-obsidian-border mb-6">
                    <h2 class="text-xs font-bold text-white mb-2 uppercase tracking-wider flex items-center">
                        <i class="fa-solid fa-wrench mr-2 text-obsidian-accent"></i> Custom Component
                    </h2>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase">Thick (in)</label>
                            <input type="number" id="custom-thick" value="1.5" step="0.5" class="w-full bg-obsidian-bg border border-obsidian-border rounded px-2 py-1 text-xs text-white focus:border-obsidian-accent outline-none">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase">Width (in)</label>
                            <input type="number" id="custom-width" value="9.25" step="0.25" class="w-full bg-obsidian-bg border border-obsidian-border rounded px-2 py-1 text-xs text-white focus:border-obsidian-accent outline-none">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="text-[10px] text-gray-500 uppercase">Length (ft)</label>
                        <input type="number" id="custom-length" value="8" class="w-full bg-obsidian-bg border border-obsidian-border rounded px-2 py-1 text-xs text-white focus:border-obsidian-accent outline-none">
                    </div>
                    <div class="flex gap-2 mb-3">
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="orientation" value="edge" checked class="hidden peer">
                            <div class="text-[10px] text-center p-1 border border-obsidian-border rounded bg-obsidian-bg peer-checked:bg-obsidian-accent peer-checked:text-white hover:bg-white/5 transition">
                                <i class="fa-solid fa-arrows-up-down mr-1"></i> On Edge
                            </div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="orientation" value="flat" class="hidden peer">
                            <div class="text-[10px] text-center p-1 border border-obsidian-border rounded bg-obsidian-bg peer-checked:bg-obsidian-accent peer-checked:text-white hover:bg-white/5 transition">
                                <i class="fa-solid fa-arrows-left-right mr-1"></i> Flat
                            </div>
                        </label>
                    </div>
                    <button onclick="addCustomItem()" class="w-full bg-obsidian-accent hover:bg-violet-600 text-white text-xs font-bold py-2 rounded transition shadow-lg">
                        <i class="fa-solid fa-plus mr-1"></i> Add
                    </button>
                </div>

                <details class="group">
                    <summary class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider cursor-pointer flex justify-between items-center">
                        <span>Quick Presets</span>
                        <i class="fa-solid fa-chevron-down group-open:rotate-180 transition"></i>
                    </summary>
                    <div class="space-y-4 pt-2">
                        <div>
                            <p class="text-[10px] text-gray-500 mb-2">Posts</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="addItem('post', 3.5, 3.5, 0, '4x4 Post')" class="flex items-center p-2 bg-obsidian-bg border border-obsidian-border hover:border-obsidian-accent hover:text-white rounded transition">
                                    <div class="w-3 h-3 bg-amber-900 mr-2 border border-amber-950"></div><span class="text-xs">4x4</span>
                                </button>
                                <button onclick="addItem('post', 5.5, 5.5, 0, '6x6 Post')" class="flex items-center p-2 bg-obsidian-bg border border-obsidian-border hover:border-obsidian-accent hover:text-white rounded transition">
                                    <div class="w-4 h-4 bg-amber-900 mr-2 border border-amber-950"></div><span class="text-xs">6x6</span>
                                </button>
                            </div>
                        </div>
                        <div>
                            <p class="text-[10px] text-gray-500 mb-2">Framing (Edge)</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="addItem('lumber', 1.5, 5.5, 8, '2x6')" class="flex items-center p-2 bg-obsidian-bg border border-obsidian-border hover:border-obsidian-accent hover:text-white rounded transition"><div class="w-2 h-4 bg-amber-800/50 mr-2 rounded-sm"></div><span class="text-xs">2x6</span></button>
                                <button onclick="addItem('lumber', 1.5, 7.25, 8, '2x8')" class="flex items-center p-2 bg-obsidian-bg border border-obsidian-border hover:border-obsidian-accent hover:text-white rounded transition"><div class="w-2 h-5 bg-amber-800/50 mr-2 rounded-sm"></div><span class="text-xs">2x8</span></button>
                                <button onclick="addItem('lumber', 1.5, 9.25, 8, '2x10')" class="flex items-center p-2 bg-obsidian-bg border border-obsidian-border hover:border-obsidian-accent hover:text-white rounded transition"><div class="w-2 h-6 bg-amber-800/50 mr-2 rounded-sm"></div><span class="text-xs">2x10</span></button>
                                <button onclick="addItem('lumber', 1.5, 11.25, 8, '2x12')" class="flex items-center p-2 bg-obsidian-bg border border-obsidian-border hover:border-obsidian-accent hover:text-white rounded transition"><div class="w-2 h-8 bg-amber-800/50 mr-2 rounded-sm"></div><span class="text-xs">2x12</span></button>
                            </div>
                        </div>
                         <div>
                            <p class="text-[10px] text-gray-500 mb-2">Decking (Flat)</p>
                            <button onclick="addItem('decking', 1, 5.5, 8, '5/4x6 Decking')" class="w-full flex items-center p-2 bg-obsidian-bg border border-obsidian-border hover:border-obsidian-accent hover:text-white rounded transition group">
                                <div class="w-6 h-2 bg-yellow-700/50 mr-2 rounded-sm"></div><span class="text-xs">5/4 x 6 Std</span>
                            </button>
                        </div>
                    </div>
                </details>
            </div>

            <div id="editor-controls" class="p-4 hidden bg-obsidian-bg/50 flex-1 border-t border-obsidian-border">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-sm font-bold text-obsidian-accent uppercase tracking-wider">Edit Selected</h2>
                    <span id="selected-type-label" class="text-[10px] bg-obsidian-border px-1.5 py-0.5 rounded text-gray-400 truncate max-w-[120px]">ITEM</span>
                </div>
                
                <div class="mb-3">
                    <label class="text-[10px] text-gray-500 block mb-1">Length (Feet)</label>
                    <input type="number" id="item-length" min="0.5" max="100" step="0.5" class="w-full bg-obsidian-pane border border-obsidian-border rounded px-2 py-1 text-sm focus:border-obsidian-accent outline-none text-white" oninput="updateSelectedItem()">
                </div>

                <div class="grid grid-cols-2 gap-2 mb-3">
                    <button onclick="rotateItem()" class="bg-obsidian-pane border border-obsidian-border hover:bg-white/5 text-xs py-2 rounded text-white transition">
                        <i class="fa-solid fa-rotate-right mr-1"></i> Rotate 90Â°
                    </button>
                     <button onclick="duplicateItem()" class="bg-obsidian-pane border border-obsidian-border hover:bg-white/5 text-xs py-2 rounded text-white transition">
                        <i class="fa-regular fa-copy mr-1"></i> Clone
                    </button>
                </div>

                <button onclick="deleteItem()" class="w-full bg-red-900/10 text-red-400 border border-red-900/30 hover:bg-red-900/40 text-xs py-2 rounded transition">
                    Delete Item
                </button>
            </div>
        </aside>

        <div class="flex-1 relative overflow-auto bg-obsidian-bg cursor-crosshair" id="canvas-container">
            <div class="absolute top-4 left-4 z-10 pointer-events-none space-y-2 no-print">
                <div class="bg-obsidian-pane/90 px-3 py-1.5 rounded text-xs border border-obsidian-border text-gray-300 shadow-lg backdrop-blur-sm inline-flex items-center">
                   <i class="fa-solid fa-ruler-combined mr-2 text-obsidian-accent"></i> 
                   <span>1 Grid Sq = 1 Foot</span>
                </div>
                <div id="post-mode-indicator" class="hidden bg-obsidian-accent/90 px-3 py-1.5 rounded text-xs font-bold text-white shadow-lg backdrop-blur-sm">
                    <i class="fa-solid fa-crosshairs mr-1"></i> POST LAYOUT MODE ACTIVE
                 </div>
            </div>
            
            <canvas id="projectCanvas" width="3000" height="3000" class="canvas-bg shadow-2xl print:shadow-none"></canvas>
        </div>

        <aside class="w-full md:w-64 bg-obsidian-pane border-t md:border-t-0 md:border-l border-obsidian-border flex flex-col shrink-0 z-10 h-64 md:h-auto no-print">
            <div class="p-3 border-b border-obsidian-border bg-obsidian-pane flex justify-between items-center">
                <h2 class="text-sm font-bold text-white tracking-wider">Bill of Materials</h2>
                <button onclick="window.print()" class="text-xs bg-obsidian-accent hover:bg-violet-600 text-white px-2 py-1 rounded transition flex items-center">
                    <i class="fa-solid fa-print mr-1"></i> Print View
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-0">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-obsidian-bg text-gray-500 text-[10px] uppercase">
                        <tr>
                            <th class="p-2 font-normal">Item</th>
                            <th class="p-2 font-normal">Len.</th>
                            <th class="p-2 font-normal text-right">Qty</th>
                        </tr>
                    </thead>
                    <tbody id="bom-body" class="text-xs font-mono text-gray-300">
                        </tbody>
                </table>
            </div>
            <div class="p-3 border-t border-obsidian-border bg-obsidian-bg text-center text-xs text-gray-500">
                Total Items: <span id="total-count" class="text-white font-bold">0</span>
            </div>
        </aside>

    </main>

    <footer class="bg-obsidian-pane border-t border-obsidian-border py-3 text-center shrink-0 z-10 flex flex-col md:flex-row justify-center items-center gap-3 no-print">
        <a href="https://homelabplayground.com" class="text-gray-500 hover:text-violet-400 text-xs transition-colors font-sans no-underline">HomeLab Playground</a>
        <span class="hidden md:block text-obsidian-border mx-1">|</span>
        <a href="https://www.buymeacoffee.com/bryjogar" target="_blank" class="inline-flex items-center px-3 py-1 bg-obsidian-accent hover:bg-violet-600 text-white text-xs font-sans rounded-full transition-colors no-underline"><i class="fa-solid fa-mug-hot mr-1.5"></i><span>Support The Tools</span></a>
    </footer>

    <script>
        const PIXELS_PER_FOOT = 40; 
        const SNAP_GRID = 5;

        const canvas = document.getElementById('projectCanvas');
        const ctx = canvas.getContext('2d');
        const canvasContainer = document.getElementById('canvas-container');
        
        let items = []; 
        let selectedId = null;
        let isDragging = false;
        let dragOffsetX = 0, dragOffsetY = 0;

        // View State
        let showPostMode = false;
        let layers = {
            post: true,
            lumber: true, 
            decking: true,
            custom: true // custom is lumped into lumber/decking usually but good to have
        };

        function init() {
            resetView();
            draw();
            // Add initial example posts so the mode makes sense immediately
            addItem('post', 5.5, 5.5, 0, '6x6 Post', canvas.width/2 - 100, canvas.height/2 - 100);
            addItem('post', 5.5, 5.5, 0, '6x6 Post', canvas.width/2 + 100, canvas.height/2 - 100);
             addItem('post', 5.5, 5.5, 0, '6x6 Post', canvas.width/2 - 100, canvas.height/2 + 100);
        }

        function resetView() {
             canvasContainer.scrollTop = (canvas.height - canvasContainer.clientHeight) / 2;
             canvasContainer.scrollLeft = (canvas.width - canvasContainer.clientWidth) / 2;
        }

        function generateId() { return Math.random().toString(36).substr(2, 9); }

        // --- Layer & View Controls ---

        function togglePostMode() {
            showPostMode = document.getElementById('toggle-post-coords').checked;
            document.getElementById('post-mode-indicator').classList.toggle('hidden', !showPostMode);
            
            // Auto-hide other layers when in post mode for clarity
            if (showPostMode) {
                layers.lumber = false;
                layers.decking = false;
            } else {
                layers.lumber = true;
                layers.decking = true;
            }
            updateLayerButtons();
            draw();
        }

        function toggleLayer(layerName) {
            layers[layerName] = !layers[layerName];
            // If manually toggling, disable auto-post mode to avoid confusion
            if (showPostMode && (layerName === 'lumber' || layerName === 'decking') && layers[layerName]) {
                 showPostMode = false;
                 document.getElementById('toggle-post-coords').checked = false;
                 document.getElementById('post-mode-indicator').classList.add('hidden');
            }
            updateLayerButtons();
            draw();
        }

        function updateLayerButtons() {
            ['post', 'lumber', 'decking'].forEach(l => {
                const btn = document.getElementById(`btn-layer-${l}`);
                if(layers[l]) {
                    btn.innerHTML = '<i class="fa-solid fa-eye"></i>';
                    btn.classList.remove('bg-obsidian-pane', 'text-gray-500');
                    btn.classList.add('bg-obsidian-accent', 'text-white');
                } else {
                     btn.innerHTML = '<i class="fa-solid fa-eye-slash"></i>';
                     btn.classList.remove('bg-obsidian-accent', 'text-white');
                     btn.classList.add('bg-obsidian-pane', 'text-gray-500');
                }
            });
        }


        // --- Item Manipulation ---

        function addCustomItem() {
            const thick = parseFloat(document.getElementById('custom-thick').value);
            const width = parseFloat(document.getElementById('custom-width').value);
            const length = parseFloat(document.getElementById('custom-length').value);
            const orientation = document.querySelector('input[name="orientation"]:checked').value;
            const name = `Custom ${thick}"x${width}"`;
            let type = (orientation === 'flat') ? 'decking' : 'lumber';
            addItem(type, thick, width, length, name);
        }

        function addItem(type, dim1, dim2, lengthFt = 0, nameOverride = '', startX = null, startY = null) {
            const viewX = startX ?? canvasContainer.scrollLeft + (canvasContainer.clientWidth / 2);
            const viewY = startY ?? canvasContainer.scrollTop + (canvasContainer.clientHeight / 2);

            let renderW, renderH, color, zIndex, name, actualType = type;

            if (type === 'post') {
                renderW = (dim1 / 12) * PIXELS_PER_FOOT;
                renderH = (dim2 / 12) * PIXELS_PER_FOOT;
                color = '#451a03'; // amber-950
                zIndex = 10;
                name = nameOverride;
            } else if (type === 'lumber' || type.includes('custom')) {
                renderW = lengthFt * PIXELS_PER_FOOT;
                renderH = (dim1 / 12) * PIXELS_PER_FOOT; // Thickness
                if (renderH < 4) renderH = 4; // Min visibility
                color = nameOverride.includes('Custom') ? '#ea580c' : '#d97706';
                zIndex = 20;
                name = nameOverride;
                actualType = 'lumber';
            } else if (type === 'decking') {
                renderW = lengthFt * PIXELS_PER_FOOT;
                renderH = (dim2 / 12) * PIXELS_PER_FOOT; // Width
                color = '#ca8a04';
                zIndex = 30;
                name = nameOverride;
            }

            const newItem = {
                id: generateId(), type: actualType, name: name,
                x: viewX - (renderW/2), y: viewY - (renderH/2),
                w: renderW, h: renderH,
                lengthFt: lengthFt, rotation: 0, color: color, zIndex: zIndex,
                dim1: dim1, dim2: dim2
            };
            items.push(newItem);
            selectItem(newItem.id);
            draw();
            updateBOM();
        }

        function deleteItem() {
            if (!selectedId) return;
            items = items.filter(i => i.id !== selectedId);
            selectedId = null;
            updateUI(); draw(); updateBOM();
        }

        function clearCanvas() {
            if(confirm('Clear all items?')) { items = []; selectedId = null; updateUI(); draw(); updateBOM(); }
        }

        function rotateItem() {
            if (!selectedId) return;
            const item = items.find(i => i.id === selectedId);
            if (item) {
                [item.w, item.h] = [item.h, item.w]; // Swap W/H
                item.rotation = (item.rotation + 90) % 360;
                draw();
            }
        }

        function duplicateItem() {
            if (!selectedId) return;
            const original = items.find(i => i.id === selectedId);
            if (original) {
                const clone = JSON.parse(JSON.stringify(original));
                clone.id = generateId(); clone.x += 15; clone.y += 15;
                items.push(clone); selectItem(clone.id); draw(); updateBOM();
            }
        }

        function updateSelectedItem() {
            if (!selectedId) return;
            const item = items.find(i => i.id === selectedId);
            const newLength = parseFloat(document.getElementById('item-length').value);
            if (newLength > 0 && item.type !== 'post') {
                item.lengthFt = newLength;
                if (item.w > item.h) item.w = newLength * PIXELS_PER_FOOT;
                else item.h = newLength * PIXELS_PER_FOOT;
                draw(); updateBOM();
            }
        }

        function selectItem(id) { selectedId = id; updateUI(); draw(); }

        function updateUI() {
            const controls = document.getElementById('editor-controls');
            if (selectedId) {
                const item = items.find(i => i.id === selectedId);
                controls.classList.remove('hidden');
                document.getElementById('selected-type-label').innerText = item.name;
                document.getElementById('item-length').value = item.lengthFt || 0;
                document.getElementById('item-length').disabled = (item.type === 'post'); 
            } else { controls.classList.add('hidden'); }
        }

        function updateBOM() {
            const tbody = document.getElementById('bom-body'); tbody.innerHTML = '';
            const grouped = {};
            items.forEach(item => {
                const key = `${item.name}::${item.lengthFt}`;
                if (!grouped[key]) grouped[key] = { name: item.name, length: item.lengthFt, count: 0 };
                grouped[key].count++;
            });
            let total = 0;
            Object.keys(grouped).sort().forEach(key => {
                const g = grouped[key]; total += g.count;
                tbody.innerHTML += `
                    <tr class="border-b border-obsidian-border/50 last:border-0 hover:bg-white/5 transition">
                        <td class="p-2 text-white font-medium truncate">${g.name}</td>
                        <td class="p-2 text-obsidian-accent">${g.length > 0 ? g.length+"'" : '-'}</td>
                        <td class="p-2 text-right font-bold text-gray-400">${g.count}</td>
                    </tr>`;
            });
            document.getElementById('total-count').innerText = total;
        }

        // --- Drawing Core ---

        function pxToFeetInches(px) {
            const totalFeet = px / PIXELS_PER_FOOT;
            const feet = Math.floor(totalFeet);
            const inches = Math.round((totalFeet - feet) * 12);
            return `${feet}' ${inches}"`;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Filter visible items based on layers
            let visibleItems = items.filter(i => layers[i.type]);
            visibleItems.sort((a, b) => a.zIndex - b.zIndex);

            // --- Post Coordinate Mode Logic ---
            if (showPostMode) {
                // Ensure only posts are visible regardless of layer toggle state during this mode
                visibleItems = items.filter(i => i.type === 'post');

                if (visibleItems.length > 0) {
                    // Find Datum (Top-Left most post)
                    let datum = visibleItems[0];
                    visibleItems.forEach(item => {
                        if (item.y < datum.y || (item.y === datum.y && item.x < datum.x)) {
                            datum = item;
                        }
                    });

                    // Draw Datum Axis
                    ctx.save();
                    ctx.strokeStyle = '#7c3aed'; // accent
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(datum.x + datum.w/2, datum.y + datum.w/2); ctx.lineTo(datum.x + datum.w/2 + 1000, datum.y + datum.w/2); // X axis
                    ctx.moveTo(datum.x + datum.w/2, datum.y + datum.w/2); ctx.lineTo(datum.x + datum.w/2, datum.y + datum.w/2 + 1000); // Y axis
                    ctx.stroke();
                    
                    ctx.fillStyle = '#7c3aed';
                    ctx.font = 'bold 14px sans-serif';
                    ctx.fillText("START POINT (0,0)", datum.x - 20, datum.y - 10);
                    ctx.restore();

                    // Calculate and draw coordinates for others
                    visibleItems.forEach(item => {
                        if (item === datum) return;
                        const dx = Math.abs(item.x - datum.x);
                        const dy = Math.abs(item.y - datum.y);
                        
                        const coords = `X: ${pxToFeetInches(dx)} | Y: ${pxToFeetInches(dy)}`;

                        ctx.save();
                        ctx.fillStyle = '#fff';
                        ctx.shadowColor = '#000'; ctx.shadowBlur = 4;
                        ctx.font = '12px monospace';
                        // Offset label slightly
                        ctx.fillText(coords, item.x + item.w + 10, item.y + item.h / 2 + 4);

                        // Draw faint connector lines to datum axis
                        ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                        ctx.lineWidth = 1;
                        ctx.setLineDash([2, 2]);
                        ctx.beginPath();
                        // Horizontal back to Y-axis
                        ctx.moveTo(item.x + item.w/2, item.y + item.h/2);
                        ctx.lineTo(datum.x + datum.w/2, item.y + item.h/2);
                        // Vertical up to X-axis
                        ctx.moveTo(item.x + item.w/2, item.y + item.h/2);
                        ctx.lineTo(item.x + item.w/2, datum.y + datum.h/2);
                        ctx.stroke();
                        ctx.restore();
                    });
                }
            }

            // --- Standard Item Drawing ---
            visibleItems.forEach(item => {
                ctx.save();
                
                if (item.id === selectedId) {
                    ctx.shadowColor = '#7c3aed'; ctx.shadowBlur = 15; ctx.strokeStyle = '#a78bfa';
                } else {
                    // Less shadow in post mode for clarity of dimensions
                    ctx.shadowColor = showPostMode ? 'transparent' : 'rgba(0,0,0,0.5)'; 
                    ctx.shadowBlur = showPostMode ? 0 : 5; 
                    ctx.strokeStyle = showPostMode ? '#666' : '#111';
                }

                ctx.fillStyle = item.color;
                ctx.fillRect(item.x, item.y, item.w, item.h);
                ctx.lineWidth = (item.type === 'post' && showPostMode) ? 2 : 1;
                ctx.strokeRect(item.x, item.y, item.w, item.h);

                // Length Labels (skip for posts or small items)
                if (!showPostMode && item.lengthFt > 0 && item.w > 25 && item.h > 12) {
                    ctx.fillStyle = 'rgba(255,255,255,0.9)'; ctx.font = 'bold 10px sans-serif'; ctx.shadowBlur = 0;
                    const txt = item.lengthFt + "'"; const m = ctx.measureText(txt);
                    if (m.width < (Math.max(item.w, item.h) - 4)) {
                        ctx.fillText(txt, item.x + (item.w/2) - (m.width/2), item.y + (item.h/2) + 3);
                    }
                }
                ctx.restore();
            });
        }

        // --- Interactions ---

        function getMousePos(evt) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (evt.clientX - rect.left) * (canvas.width / rect.width),
                y: (evt.clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function isHit(pos, item) {
            if (!layers[item.type] && !showPostMode) return false; // Don't hit hidden items
            if (showPostMode && item.type !== 'post') return false;

            const padding = (item.h < 10 || item.w < 10) ? 10 : 0; // Easier selection for thin items
            return pos.x >= item.x - padding && pos.x <= item.x + item.w + padding &&
                   pos.y >= item.y - padding && pos.y <= item.y + item.h + padding;
        }

        canvas.addEventListener('mousedown', (e) => {
            if(e.button !== 0) return; // Only Left Click
            const pos = getMousePos(e);
            let hitItem = null;
            for (let i = items.length - 1; i >= 0; i--) {
                if (isHit(pos, items[i])) { hitItem = items[i]; break; }
            }
            if (hitItem) {
                isDragging = true; selectItem(hitItem.id);
                dragOffsetX = pos.x - hitItem.x; dragOffsetY = pos.y - hitItem.y;
            } else { selectedId = null; updateUI(); draw(); }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isDragging && selectedId) {
                const pos = getMousePos(e);
                const item = items.find(i => i.id === selectedId);
                if (item) {
                    // Snap to grid normally, but if in post mode, maybe snap tighter? sticking to standard snap for now.
                    item.x = Math.round((pos.x - dragOffsetX) / SNAP_GRID) * SNAP_GRID;
                    item.y = Math.round((pos.y - dragOffsetY) / SNAP_GRID) * SNAP_GRID;
                    draw();
                }
            }
        });

        window.addEventListener('mouseup', () => { isDragging = false; });
        
        // Basic Touch Support
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); if(e.touches.length > 1) return; const t = e.touches[0]; canvas.dispatchEvent(new MouseEvent('mousedown', { clientX: t.clientX, clientY: t.clientY, button: 0 })); }, {passive:false});
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); if(e.touches.length > 1) return; const t = e.touches[0]; canvas.dispatchEvent(new MouseEvent('mousemove', { clientX: t.clientX, clientY: t.clientY })); }, {passive:false});
        canvas.addEventListener('touchend', (e) => { window.dispatchEvent(new MouseEvent('mouseup')); });
        
        document.addEventListener('keydown', (e) => { if(e.key === 'Delete' || e.key === 'Backspace') deleteItem(); });

        // Initialize
        init();
    </script>
</body>
</html>