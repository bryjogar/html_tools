<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homelab Day Planner</title>
    
    <link rel="icon" type="image/png" href="https://homelabplayground.com/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        obsidian: {
                            bg: '#1e1e1e',
                            pane: '#252526',
                            border: '#3c3c3c',
                            accent: '#7c3aed',
                            text: '#cccccc'
                        }
                    },
                    fontFamily: {
                        mono: ['"Fira Code"', 'Consolas', 'Monaco', 'monospace'],
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }
        ::-webkit-scrollbar-thumb {
            background: #3c3c3c;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Utility */
        .glass-panel {
            background: rgba(37, 37, 38, 0.7);
            backdrop-filter: blur(10px);
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .dashed-action:hover {
            border-color: #7c3aed;
            color: #7c3aed;
            background-color: rgba(124, 58, 237, 0.05);
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden bg-obsidian-bg text-obsidian-text font-sans selection:bg-obsidian-accent selection:text-white">

    <header class="h-14 bg-obsidian-pane border-b border-obsidian-border flex items-center justify-between px-4 shrink-0 z-20 shadow-md">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-calendar-check text-obsidian-accent text-lg"></i>
            <h1 class="font-semibold text-white tracking-wide">Day Planner</h1>
        </div>
        <div class="flex gap-2">
            <button onclick="openHabitModal()" class="w-8 h-8 rounded hover:bg-white/5 text-obsidian-text hover:text-white transition-colors flex items-center justify-center" title="Add Habit">
                <i class="fa-solid fa-plus-circle"></i>
            </button>
            <button onclick="openTaskModal()" class="px-3 py-1.5 bg-obsidian-accent hover:bg-violet-600 text-white text-xs font-medium rounded transition-colors flex items-center gap-2">
                <i class="fa-solid fa-plus"></i>
                <span class="hidden sm:inline">New Task</span>
            </button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 md:p-6 space-y-8 scroll-smooth" id="main-content">
        
        <section>
            <h2 class="text-sm font-mono uppercase text-gray-500 mb-3 flex items-center gap-2">
                <i class="fa-solid fa-repeat"></i> Daily Habits
            </h2>
            <div id="habit-list" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                </div>
        </section>

        <section id="overdue-section" class="hidden">
            <h2 class="text-sm font-mono uppercase text-red-400 mb-3 flex items-center gap-2">
                <i class="fa-solid fa-triangle-exclamation"></i> Overdue
            </h2>
            <div id="overdue-list" class="space-y-2">
                </div>
        </section>

        <section>
            <h2 class="text-sm font-mono uppercase text-obsidian-accent mb-3 flex items-center gap-2">
                <i class="fa-solid fa-clock"></i> Today's Schedule
            </h2>
            <div id="today-list" class="space-y-2 mb-2">
                </div>
            
            <button id="today-empty" onclick="openTaskModal(null, getTodayStr())" class="w-full hidden dashed-action py-6 border border-dashed border-obsidian-border rounded-lg text-gray-500 transition-all flex-col items-center justify-center gap-2 group">
                <i class="fa-solid fa-plus-circle text-xl group-hover:scale-110 transition-transform"></i>
                <span class="text-sm font-medium">Add task for today</span>
            </button>
        </section>

        <section>
            <h2 class="text-sm font-mono uppercase text-gray-500 mb-3 flex items-center gap-2">
                <i class="fa-regular fa-calendar"></i> Next 3 Days
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="forecast-grid">
                </div>
        </section>

    </main>

    <div id="task-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-overlay opacity-0 transition-opacity duration-200">
        <div class="bg-obsidian-pane border border-obsidian-border rounded-lg shadow-2xl w-full max-w-md mx-4 transform scale-95 transition-transform duration-200" id="task-modal-content">
            <div class="flex justify-between items-center p-4 border-b border-obsidian-border">
                <h3 class="text-white font-medium" id="task-modal-title">New Task</h3>
                <button onclick="closeTaskModal()" class="text-gray-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-4 space-y-4">
                <input type="hidden" id="task-id">
                <div>
                    <label class="block text-xs text-gray-500 mb-1 font-mono">Title</label>
                    <input type="text" id="task-title" class="w-full bg-obsidian-bg border border-obsidian-border rounded p-2 text-white focus:border-obsidian-accent focus:outline-none transition-colors" placeholder="e.g. Server Maintenance">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1 font-mono">Description</label>
                    <textarea id="task-desc" rows="3" class="w-full bg-obsidian-bg border border-obsidian-border rounded p-2 text-white focus:border-obsidian-accent focus:outline-none transition-colors" placeholder="Details..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1 font-mono">Start Time (Optional)</label>
                        <input type="time" id="task-start" class="w-full bg-obsidian-bg border border-obsidian-border rounded p-2 text-white focus:border-obsidian-accent focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1 font-mono">Due Date & Time</label>
                        <input type="datetime-local" id="task-due" class="w-full bg-obsidian-bg border border-obsidian-border rounded p-2 text-white focus:border-obsidian-accent focus:outline-none">
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-obsidian-border flex justify-end gap-2">
                <button onclick="deleteTask()" id="btn-delete-task" class="hidden px-4 py-2 text-red-400 hover:bg-red-400/10 rounded text-sm transition-colors">Delete</button>
                <button onclick="saveTask()" class="px-4 py-2 bg-obsidian-accent hover:bg-violet-600 text-white rounded text-sm transition-colors shadow-lg shadow-violet-900/20">Save Task</button>
            </div>
        </div>
    </div>

    <div id="habit-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-overlay opacity-0 transition-opacity duration-200">
        <div class="bg-obsidian-pane border border-obsidian-border rounded-lg shadow-2xl w-full max-w-sm mx-4 transform scale-95 transition-transform duration-200" id="habit-modal-content">
            <div class="flex justify-between items-center p-4 border-b border-obsidian-border">
                <h3 class="text-white font-medium">New Habit</h3>
                <button onclick="closeHabitModal()" class="text-gray-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <label class="block text-xs text-gray-500 mb-1 font-mono">Habit Name</label>
                    <input type="text" id="habit-name" class="w-full bg-obsidian-bg border border-obsidian-border rounded p-2 text-white focus:border-obsidian-accent focus:outline-none" placeholder="e.g. Drink Water">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1 font-mono">Icon Class (FontAwesome)</label>
                    <input type="text" id="habit-icon" class="w-full bg-obsidian-bg border border-obsidian-border rounded p-2 text-white focus:border-obsidian-accent focus:outline-none" placeholder="fa-glass-water">
                    <p class="text-[10px] text-gray-600 mt-1">Leave empty for default icon.</p>
                </div>
            </div>
            <div class="p-4 border-t border-obsidian-border flex justify-end">
                <button onclick="saveHabit()" class="px-4 py-2 bg-obsidian-accent hover:bg-violet-600 text-white rounded text-sm transition-colors">Create Habit</button>
            </div>
        </div>
    </div>

    <footer class="bg-obsidian-pane border-t border-obsidian-border py-3 text-center shrink-0 z-10 flex flex-col md:flex-row justify-center items-center gap-3">
        <a href="https://homelabplayground.com" class="text-gray-500 hover:text-violet-400 text-xs transition-colors font-sans no-underline">
            HomeLab Playground
        </a>
        <span class="hidden md:block text-obsidian-border mx-1">|</span>
        <a href="https://www.buymeacoffee.com/bryjogar" target="_blank" class="inline-flex items-center px-3 py-1 bg-obsidian-accent hover:bg-violet-600 text-white text-xs font-sans rounded-full transition-colors no-underline">
            <i class="fa-solid fa-mug-hot mr-1.5"></i>
            <span>Support The Tools</span>
        </a>
    </footer>

    <script>
        // --- State Management ---
        let tasks = JSON.parse(localStorage.getItem('hlp_planner_tasks')) || [];
        let habits = JSON.parse(localStorage.getItem('hlp_planner_habits')) || [];
        let habitLogs = JSON.parse(localStorage.getItem('hlp_planner_habit_logs')) || {}; // Key: "habitId_dateStr", Val: count

        // --- Dates & Helpers ---
        const getTodayStr = () => new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD local
        
        const formatDate = (dateStr) => {
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        };
        
        const formatTime = (timeStr) => {
            if(!timeStr) return '';
            const [h, m] = timeStr.split(':');
            const d = new Date();
            d.setHours(h);
            d.setMinutes(m);
            return d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        };

        // --- Core Logic ---

        function saveData() {
            localStorage.setItem('hlp_planner_tasks', JSON.stringify(tasks));
            localStorage.setItem('hlp_planner_habits', JSON.stringify(habits));
            localStorage.setItem('hlp_planner_habit_logs', JSON.stringify(habitLogs));
            renderAll();
        }

        // --- Habits ---

        function saveHabit() {
            const name = document.getElementById('habit-name').value;
            const icon = document.getElementById('habit-icon').value || 'fa-check';
            if (!name) return;

            habits.push({
                id: Date.now().toString(),
                name,
                icon
            });
            
            document.getElementById('habit-name').value = '';
            document.getElementById('habit-icon').value = '';
            closeHabitModal();
            saveData();
        }

        function incrementHabit(id) {
            const key = `${id}_${getTodayStr()}`;
            habitLogs[key] = (habitLogs[key] || 0) + 1;
            saveData();
        }

        function deleteHabit(id, event) {
            event.stopPropagation();
            if(!confirm("Remove this habit?")) return;
            habits = habits.filter(h => h.id !== id);
            saveData();
        }

        // --- Tasks ---

        function openTaskModal(taskId = null, defaultDateStr = null) {
            const modal = document.getElementById('task-modal');
            const content = document.getElementById('task-modal-content');
            const deleteBtn = document.getElementById('btn-delete-task');
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);

            if (taskId) {
                const task = tasks.find(t => t.id === taskId);
                document.getElementById('task-id').value = task.id;
                document.getElementById('task-title').value = task.title;
                document.getElementById('task-desc').value = task.desc;
                document.getElementById('task-start').value = task.start || '';
                document.getElementById('task-due').value = task.due;
                document.getElementById('task-modal-title').innerText = "Edit Task";
                deleteBtn.classList.remove('hidden');
            } else {
                document.getElementById('task-id').value = '';
                document.getElementById('task-title').value = '';
                document.getElementById('task-desc').value = '';
                document.getElementById('task-start').value = '';
                
                // Determine default time
                const now = new Date();
                
                if (defaultDateStr) {
                    // If a date is provided (e.g., clicked forecast), use that date
                    const targetDate = new Date(defaultDateStr);
                    // If target is today, use current time. If future, use 09:00 AM
                    const todayStr = getTodayStr();
                    
                    if (defaultDateStr === todayStr) {
                         now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                         document.getElementById('task-due').value = now.toISOString().slice(0, 16);
                    } else {
                        // Future date 9 AM
                        // We need to construct the ISO string carefully manually to avoid UTC shifts
                        document.getElementById('task-due').value = `${defaultDateStr}T09:00`;
                    }
                } else {
                     // No date provided, default to now
                     now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                     document.getElementById('task-due').value = now.toISOString().slice(0, 16);
                }

                document.getElementById('task-modal-title').innerText = "New Task";
                deleteBtn.classList.add('hidden');
            }
        }

        function closeTaskModal() {
            const modal = document.getElementById('task-modal');
            const content = document.getElementById('task-modal-content');
            
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        function saveTask() {
            const id = document.getElementById('task-id').value;
            const title = document.getElementById('task-title').value;
            const desc = document.getElementById('task-desc').value;
            const start = document.getElementById('task-start').value;
            const due = document.getElementById('task-due').value;

            if (!title || !due) {
                alert("Title and Due Date are required.");
                return;
            }

            if (id) {
                const index = tasks.findIndex(t => t.id === id);
                if (index !== -1) {
                    tasks[index] = { ...tasks[index], title, desc, start, due };
                }
            } else {
                tasks.push({
                    id: Date.now().toString(),
                    title,
                    desc,
                    start,
                    due,
                    completed: false
                });
            }
            closeTaskModal();
            saveData();
        }

        function toggleTaskComplete(id, event) {
            event.stopPropagation();
            const index = tasks.findIndex(t => t.id === id);
            if (index !== -1) {
                tasks[index].completed = !tasks[index].completed;
                saveData();
            }
        }

        function deleteTask() {
            const id = document.getElementById('task-id').value;
            if (confirm("Delete this task permanently?")) {
                tasks = tasks.filter(t => t.id !== id);
                closeTaskModal();
                saveData();
            }
        }

        // --- Rendering ---

        function renderHabits() {
            const container = document.getElementById('habit-list');
            container.innerHTML = '';

            if (habits.length === 0) {
                container.innerHTML = `<div class="col-span-full dashed-action rounded-lg text-center text-xs text-gray-500 py-3 cursor-pointer transition-colors" onclick="openHabitModal()">
                    <i class="fa-solid fa-plus mr-1"></i> Add your first habit
                </div>`;
                return;
            }

            habits.forEach(h => {
                const key = `${h.id}_${getTodayStr()}`;
                const count = habitLogs[key] || 0;
                
                const div = document.createElement('div');
                div.className = `bg-obsidian-pane border border-obsidian-border rounded-lg p-3 flex flex-col items-center justify-center relative group hover:border-obsidian-accent transition-colors cursor-pointer select-none`;
                div.onclick = () => incrementHabit(h.id);
                
                div.innerHTML = `
                    <button onclick="deleteHabit('${h.id}', event)" class="absolute top-1 right-1 text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity text-[10px] p-1"><i class="fa-solid fa-trash"></i></button>
                    <i class="fa-solid ${h.icon} text-xl mb-2 ${count > 0 ? 'text-obsidian-accent' : 'text-gray-600'}"></i>
                    <span class="text-xs font-medium truncate w-full text-center">${h.name}</span>
                    <div class="mt-1 text-[10px] bg-black/20 px-2 py-0.5 rounded-full text-gray-400 font-mono">${count}</div>
                `;
                container.appendChild(div);
            });
        }

        function renderAll() {
            renderHabits();
            
            const now = new Date();
            const todayStr = getTodayStr(); // YYYY-MM-DD
            
            // Sort tasks by due date
            const sortedTasks = [...tasks].sort((a, b) => new Date(a.due) - new Date(b.due));

            const overdueContainer = document.getElementById('overdue-list');
            const todayContainer = document.getElementById('today-list');
            const forecastContainer = document.getElementById('forecast-grid');
            const overdueSection = document.getElementById('overdue-section');
            const todayEmpty = document.getElementById('today-empty');

            overdueContainer.innerHTML = '';
            todayContainer.innerHTML = '';
            forecastContainer.innerHTML = '';
            
            let hasOverdue = false;
            let hasToday = false;

            // Prepare forecast buckets (Next 3 days)
            const forecastData = [];
            for(let i=1; i<=3; i++) {
                const d = new Date();
                d.setDate(d.getDate() + i);
                const isoDate = d.toLocaleDateString('en-CA'); // YYYY-MM-DD local logic
                forecastData.push({
                    date: d,
                    dateStr: isoDate,
                    items: []
                });
            }

            sortedTasks.forEach(task => {
                if (task.completed) return; 

                const dueObj = new Date(task.due);
                const dueDateStr = task.due.split('T')[0];
                
                const isOverdue = dueObj < now;
                const isToday = dueDateStr === todayStr;

                if (isOverdue) {
                    hasOverdue = true;
                    overdueContainer.appendChild(createTaskCard(task, 'overdue'));
                } else if (isToday) {
                    hasToday = true;
                    todayContainer.appendChild(createTaskCard(task, 'today'));
                } else {
                    const bucket = forecastData.find(f => f.dateStr === dueDateStr);
                    if (bucket) {
                        bucket.items.push(task);
                    }
                }
            });

            // Toggle Overdue Section visibility
            if (hasOverdue) {
                overdueSection.classList.remove('hidden');
            } else {
                overdueSection.classList.add('hidden');
            }

            // Toggle Empty State for Today
            if (hasToday) {
                todayEmpty.classList.add('hidden');
                todayEmpty.classList.remove('flex');
            } else {
                todayEmpty.classList.remove('hidden');
                todayEmpty.classList.add('flex');
            }

            // Render Forecast
            forecastData.forEach(day => {
                const dayCard = document.createElement('div');
                dayCard.className = `bg-obsidian-pane border border-obsidian-border rounded-lg p-3 h-full flex flex-col group/card hover:border-obsidian-border transition-colors`;
                
                const header = `
                    <div class="border-b border-obsidian-border pb-2 mb-2 flex justify-between items-center group-hover/card:border-obsidian-border">
                        <div class="flex items-center gap-2">
                            <span class="font-mono text-xs text-obsidian-accent font-bold uppercase">${day.date.toLocaleDateString('en-US', { weekday: 'short' })}</span>
                            <span class="text-xs text-gray-500">${day.date.getDate()}</span>
                        </div>
                        <button onclick="openTaskModal(null, '${day.dateStr}')" class="w-6 h-6 flex items-center justify-center rounded hover:bg-obsidian-accent text-gray-500 hover:text-white transition-colors" title="Add task for this day">
                            <i class="fa-solid fa-plus text-xs"></i>
                        </button>
                    </div>
                `;
                
                let content = '';
                if (day.items.length === 0) {
                    content = `<div class="flex-1 flex items-center justify-center min-h-[50px]">
                        <span class="text-[10px] text-gray-700 italic">No tasks</span>
                    </div>`;
                } else {
                    content = `<div class="space-y-2 flex-1 overflow-y-auto max-h-48 pr-1">
                        ${day.items.map(t => `
                            <div onclick="openTaskModal('${t.id}')" class="group flex items-start gap-2 p-2 rounded bg-obsidian-bg/50 border border-transparent hover:border-obsidian-border cursor-pointer transition-colors">
                                <div class="mt-0.5 w-1.5 h-1.5 rounded-full bg-obsidian-accent shrink-0"></div>
                                <div class="overflow-hidden">
                                    <div class="text-xs text-gray-300 truncate font-medium group-hover:text-white transition-colors">${t.title}</div>
                                    <div class="text-[10px] text-gray-500">${t.start ? t.start : ''}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
                }
                
                dayCard.innerHTML = header + content;
                forecastContainer.appendChild(dayCard);
            });
        }

        function createTaskCard(task, type) {
            const div = document.createElement('div');
            
            // Base styles
            let borderClass = 'border-obsidian-border hover:border-obsidian-accent';
            let bgClass = 'bg-obsidian-pane';
            
            if (type === 'overdue') {
                borderClass = 'border-red-900/50 hover:border-red-500/50';
                bgClass = 'bg-gradient-to-r from-[#2a1515] to-[#252526]';
            }

            div.className = `${bgClass} border ${borderClass} rounded-lg p-3 flex items-center justify-between group transition-all duration-200 cursor-pointer shadow-sm`;
            div.onclick = () => openTaskModal(task.id);

            const timeDisplay = task.start ? 
                `<span class="font-mono text-obsidian-accent mr-2">${formatTime(task.start)}</span>` : '';

            const overdueBadge = type === 'overdue' ? 
                `<span class="ml-2 text-[10px] bg-red-900/50 text-red-300 px-1.5 py-0.5 rounded border border-red-800/50">Overdue</span>` : '';

            div.innerHTML = `
                <div class="flex items-center gap-3 overflow-hidden">
                    <button onclick="toggleTaskComplete('${task.id}', event)" class="w-5 h-5 rounded-full border border-gray-500 hover:border-obsidian-accent hover:bg-obsidian-accent/20 flex items-center justify-center transition-colors shrink-0">
                        <i class="fa-solid fa-check text-[10px] opacity-0 text-white"></i>
                    </button>
                    <div class="flex flex-col overflow-hidden">
                        <div class="flex items-center">
                            <h4 class="text-sm font-medium text-gray-200 truncate group-hover:text-white transition-colors">${task.title}</h4>
                            ${overdueBadge}
                        </div>
                        <div class="text-xs text-gray-500 truncate mt-0.5">
                            ${timeDisplay}
                            ${task.desc ? `<span class="opacity-75">- ${task.desc}</span>` : ''}
                        </div>
                    </div>
                </div>
                <div class="text-gray-500 group-hover:text-obsidian-accent transition-colors pl-2">
                    <i class="fa-solid fa-pen-to-square"></i>
                </div>
            `;
            return div;
        }

        // --- Init ---
        // Pre-load logic functions
        function openHabitModal() {
            const modal = document.getElementById('habit-modal');
            const content = document.getElementById('habit-modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeHabitModal() {
            const modal = document.getElementById('habit-modal');
            const content = document.getElementById('habit-modal-content');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        // Initial render
        renderAll();
        
        // Refresh every minute to check overdue status
        setInterval(renderAll, 60000);

    </script>
</body>
</html>